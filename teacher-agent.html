<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Generator - Succes Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-blur: blur(16px);
            --shadow-apple: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fbfbfd;
            height: 100dvh;
            overflow: hidden;
            color: #1d1d1f;
            letter-spacing: -0.022em;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .font-black {
            font-family: "SF Pro Display", "SF Pro Text", -apple-system, sans-serif;
            letter-spacing: -0.02em;
        }

        .glass-apple {
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 0.5px solid var(--glass-border);
            box-shadow: var(--shadow-apple);
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.8);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        .bottom-lift {
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
        }

        .input-apple {
            background: #f5f5f7;
            border: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .input-apple:focus {
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 125, 250, 0.1);
            outline: none;
        }

        .btn-apple {
            border-radius: 14px;
            font-weight: 510;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .btn-apple:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .visualizer-bar {
            width: 4px;
            background-color: #3b82f6;
            border-radius: 4px;
            animation: quiet 1s ease-in-out infinite;
        }

        .speaking .visualizer-bar {
            animation: talking 0.5s ease-in-out infinite alternate;
        }

        @keyframes talking {
            0% {
                height: 8px;
            }

            100% {
                height: 24px;
            }
        }

        @keyframes quiet {
            0% {
                height: 4px;
            }

            50% {
                height: 4px;
            }

            100% {
                height: 4px;
            }
        }

        .speaking .visualizer-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .speaking .visualizer-bar:nth-child(2) {
            animation-delay: 0.1s;
        }

        .speaking .visualizer-bar:nth-child(3) {
            animation-delay: 0.2s;
        }

        /* Force Landscape Overlay */
        #landscape-overlay {
            display: none;
        }

        @media only screen and (min-device-width: 768px) and (max-device-width: 1024px) and (orientation: portrait) {
            #landscape-overlay {
                display: flex;
            }
        }
    </style>
</head>

<body class="bg-slate-50 h-[100dvh] w-full flex flex-col overflow-hidden">
    <!-- Landscape Warning Overlay -->
    <div id="landscape-overlay"
        class="fixed inset-0 z-[100] bg-slate-900 text-white flex-col items-center justify-center text-center p-10 animate-fade-in">
        <i class="fa-solid fa-rotate-left text-6xl mb-6 animate-pulse"></i>
        <h2 class="text-3xl font-black uppercase tracking-widest mb-4">Please Rotate Device</h2>
        <p class="text-lg text-gray-400 font-medium">This experience is optimized for Landscape mode.</p>
    </div>

    <!-- Header -->
    <header class="sticky-header h-16 shrink-0 px-4 flex justify-between items-center z-30">
        <div class="w-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" title="Back to Dashboard"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-solid fa-arrow-left text-sm"></i>
                </a>
                <h1 class="font-black text-gray-900 tracking-tight text-sm uppercase">AI Teacher</h1>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <button onclick="Generator.copyRoomId()" title="Copy Room ID"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-regular fa-copy text-sm"></i>
                </button>
                <div class="relative group">
                    <button onclick="Generator.toggleQR()" title="Show QR Code"
                        class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                        <i class="fa-solid fa-qrcode text-sm"></i>
                    </button>
                    <!-- QR Dropdown -->
                    <div id="qr-dropdown"
                        class="absolute right-0 top-14 w-64 bg-white rounded-2xl shadow-apple border border-gray-100 p-6 hidden animate-fade-in z-50 flex flex-col items-center">
                        <div id="qrcode" class="mb-4 bg-white p-2 rounded-xl shadow-sm border border-gray-100"></div>
                        <button onclick="Generator.downloadQR()"
                            class="flex items-center gap-2 text-[10px] font-black text-[#0071e3] hover:text-[#0077ed] uppercase tracking-widest transition-colors py-2 px-4 rounded-full hover:bg-blue-50">
                            <i class="fa-solid fa-download"></i> Download QR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-1 md:p-2 w-full flex flex-col min-h-0">
        <div
            class="glass-apple rounded-[24px] md:rounded-[32px] p-6 md:p-10 flex-1 flex flex-col animate-slide-up w-full max-w-full mx-auto overflow-hidden shadow-2xl">
            <div class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
                <div class="mb-8 md:mb-12">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-8 h-8 md:w-10 md:h-10 rounded-lg md:rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                            <i class="fa-solid fa-wand-magic-sparkles text-sm md:text-base"></i>
                        </div>
                        <h2 class="text-2xl md:text-4xl font-black text-gray-900 tracking-tight">Generate Lesson</h2>
                    </div>
                    <p class="text-sm md:text-base text-gray-500 font-medium max-w-xl">
                        Sentence-by-sentence broadcast. AI sentences are hard-capped at 15 words.
                    </p>
                </div>

                <div class="flex-1 w-full max-w-full mx-auto px-4 py-8 md:py-10 flex flex-col items-center">

                    <!-- Connection Status & Visualizer -->
                    <div id="status-badge"
                        class="mb-6 md:mb-8 px-5 py-2.5 bg-white text-gray-600 rounded-full text-xs font-bold uppercase tracking-widest border border-gray-200 flex items-center gap-3 shadow-sm transition-all duration-300">
                        <div class="flex items-center gap-1 h-5 visualizer opacity-50 transition-opacity">
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                        </div>
                        <span id="status-text">Connected to Classroom</span>
                    </div>

                    <div class="w-full space-y-6 md:space-y-10 flex-1">
                        <!-- Tabs -->
                        <div class="flex items-center gap-2">
                            <button id="tab-ai" onclick="Generator.setMode('ai')"
                                class="px-4 py-2 rounded-full text-sm font-bold border transition-colors">
                                AI Topic
                            </button>
                            <button id="tab-story" onclick="Generator.setMode('story')"
                                class="px-4 py-2 rounded-full text-sm font-bold border transition-colors">
                                Story
                            </button>
                        </div>

                        <!-- AI Panel -->
                        <div id="panel-ai" class="space-y-4 md:space-y-6">
                            <label
                                class="block text-[11px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">Subject
                                / Topic</label>

                            <!-- Presets ScrollView -->
                            <div class="flex gap-2 mb-3 overflow-x-auto pb-2 custom-scrollbar -mx-1 px-1">
                                <button onclick="Generator.setTopic('Construction Safety Officer Duties')"
                                    class="whitespace-nowrap px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-full text-sm font-bold transition-colors border border-blue-100/50">
                                    üë∑ Safety Officer
                                </button>
                                <button onclick="Generator.setTopic('Proper Harness Usage & Inspection')"
                                    class="whitespace-nowrap px-4 py-2 bg-orange-50 hover:bg-orange-100 text-orange-600 rounded-full text-sm font-bold transition-colors border border-orange-100/50">
                                    ü™ù Harness Safety
                                </button>
                                <button onclick="Generator.setTopic('Complete PPE Guidelines')"
                                    class="whitespace-nowrap px-4 py-2 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold transition-colors border border-yellow-100/50">
                                    ‚õëÔ∏è PPE Rules
                                </button>
                                <button onclick="Generator.setTopic('Identifying Site Hazards')"
                                    class="whitespace-nowrap px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-full text-sm font-bold transition-colors border border-red-100/50">
                                    ‚ö†Ô∏è Site Hazards
                                </button>
                                <button onclick="Generator.setTopic('Emergency First Aid Response')"
                                    class="whitespace-nowrap px-4 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-full text-sm font-bold transition-colors border border-green-100/50">
                                    üöë First Aid
                                </button>
                            </div>

                            <textarea id="topic-input" rows="4"
                                class="input-apple w-full px-5 py-4 md:px-7 md:py-6 text-gray-900 outline-none placeholder:text-gray-300 resize-none text-[16px] md:text-[18px]"
                                placeholder="e.g. How photosynthesis works, or the history of the Roman Empire..."></textarea>
                        </div>

                        <!-- Story Panel (text input only) -->
                        <div id="panel-story" class="hidden">
                            <textarea id="story-input" rows="10"
                                class="input-apple w-full px-5 py-4 md:px-7 md:py-6 text-gray-900 outline-none placeholder:text-gray-300 resize-none text-[16px] md:text-[18px]"
                                placeholder="Paste your story here. Chunking uses period '.' only. No rewriting."></textarea>
                            <p class="text-xs text-gray-500 font-medium mt-2">
                                Splits strictly on '.' for broadcast chunks. Text is not rewritten.
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-4 max-w-3xl">
                        <button id="start-btn" onclick="Generator.primaryAction()" title="Primary Action"
                            class="flex-1 group relative overflow-hidden rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 p-[2px] shadow-lg shadow-blue-500/30 transition-all hover:scale-[1.02] hover:shadow-blue-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                                <i class="fa-solid fa-wand-magic-sparkles text-xl drop-shadow-sm"></i>
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Generate
                                    Lesson</span>
                            </div>
                        </button>

                        <button id="broadcast-btn" onclick="Generator.startBroadcast()" title="Start Broadcast"
                            class="hidden flex-1 group relative overflow-hidden rounded-2xl bg-gradient-to-r from-emerald-500 to-emerald-600 p-[2px] shadow-lg shadow-emerald-500/30 transition-all hover:scale-[1.02] hover:shadow-emerald-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-emerald-500 to-emerald-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                                <i class="fa-solid fa-tower-broadcast text-xl drop-shadow-sm animate-pulse"></i>
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Start
                                    Broadcast</span>
                            </div>
                        </button>

                        <button id="stop-btn" onclick="Generator.stop()" title="Stop Lesson"
                            class="hidden group relative overflow-hidden rounded-2xl bg-gradient-to-r from-red-500 to-red-600 p-[2px] shadow-lg shadow-red-500/30 transition-all hover:scale-[1.02] hover:shadow-red-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-red-500 to-red-600 px-10 py-4 md:py-5 text-white transition-all">
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">STOP</span>
                            </div>
                        </button>
                    </div>

                    <div id="log" class="space-y-3 pb-4">
                        <!-- Log entries -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const CONFIG = {
            API_KEY: "sk-RPKYynytRIODIzGGm0GYgEF7RMgQqlee9upYDni5Yoi9gtLe",
            MOONSHOT_URL: "https://api.moonshot.ai/v1/chat/completions",
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com"
            }
        };

        const Generator = {
            isActive: false,
            queue: [], // queue items: { text: string, ssml: string }
            interval: null,
            db: null,
            wakeLock: null,
            silentAudio: null,
            mode: "ai", // "ai" | "story"
            session: JSON.parse(localStorage.getItem('orbit_session') || '{}'),

            init() {
                const app = initializeApp(CONFIG.FIREBASE);
                this.db = getDatabase(app);
                if (!this.session.room) {
                    alert("No active session found. Please login via index.html first.");
                    window.location.href = 'index.html';
                    return;
                }
                window.Generator = this;

                // Initialize QR Code
                setTimeout(() => { this.generateQR(); }, 500);

                // Default mode
                this.setMode(this.mode);
            },

            // =========================
            // UI: Tabs + Primary Action
            // =========================
            setMode(mode) {
                this.mode = mode;

                const tabAI = document.getElementById("tab-ai");
                const tabStory = document.getElementById("tab-story");
                const panelAI = document.getElementById("panel-ai");
                const panelStory = document.getElementById("panel-story");

                const activeClasses = ["bg-blue-50", "text-blue-700", "border-blue-200"];
                const idleClasses = ["bg-white", "text-gray-700", "border-gray-200"];

                const applyTab = (btn, active) => {
                    btn.classList.remove(...activeClasses, ...idleClasses);
                    btn.classList.add(...(active ? activeClasses : idleClasses));
                };

                applyTab(tabAI, mode === "ai");
                applyTab(tabStory, mode === "story");

                panelAI.classList.toggle("hidden", mode !== "ai");
                panelStory.classList.toggle("hidden", mode !== "story");

                // If idle, refresh the primary button label
                this.renderPrimaryButton();
            },

            primaryAction() {
                if (this.mode === "story") return this.queueStory();
                return this.start();
            },

            renderPrimaryButton() {
                const startBtn = document.getElementById('start-btn');
                if (!startBtn) return;

                // If we're not in idle (button might be hidden/overridden), do nothing here.
                const isHidden = startBtn.classList.contains("hidden");
                if (isHidden) return;

                if (this.mode === "story") {
                    startBtn.title = "Queue Story";
                    startBtn.innerHTML = `
                        <div class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                            <i class="fa-solid fa-scissors text-xl drop-shadow-sm"></i>
                            <span class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Queue Story</span>
                        </div>
                    `;
                } else {
                    startBtn.title = "Generate Lesson";
                    startBtn.innerHTML = `
                        <div class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                            <i class="fa-solid fa-wand-magic-sparkles text-xl drop-shadow-sm"></i>
                            <span class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Generate Lesson</span>
                        </div>
                    `;
                }
            },

            // =========================
            // QR + Room
            // =========================
            generateQR() {
                const studentUrl = window.location.href.replace('teacher-ai.html', 'index.html') + '?room=' + this.session.room;
                const qrContainer = document.getElementById("qrcode");
                qrContainer.innerHTML = ""; // Clear existing
                new QRCode(qrContainer, {
                    text: studentUrl,
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            },

            toggleQR() {
                const dropdown = document.getElementById('qr-dropdown');
                dropdown.classList.toggle('hidden');
            },

            downloadQR() {
                const qrCanvas = document.querySelector('#qrcode canvas');
                if (!qrCanvas) return;

                const link = document.createElement('a');
                link.download = `succes-class-qr-${this.session.room}.png`;
                link.href = qrCanvas.toDataURL();
                link.click();
            },

            copyRoomId() {
                navigator.clipboard.writeText(this.session.room).then(() => {
                    this.log(`Room ID ${this.session.room} copied to clipboard!`, "success");
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            },

            // =========================
            // STORY: split by period ONLY
            // =========================
            splitStoryByPeriod(text) {
                const chunks = [];
                let start = 0;

                for (let i = 0; i < text.length; i++) {
                    if (text[i] === '.') {
                        chunks.push(text.slice(start, i + 1)); // include the period
                        start = i + 1;
                    }
                }
                if (start < text.length) chunks.push(text.slice(start));

                // keep original content; only remove pure-whitespace chunks
                return chunks.filter(c => c.replace(/\s/g, '').length > 0);
            },

            escapeForSSML(raw) {
                // Preserve visible text by storing raw in `text`, and only escape inside `ssml`.
                // This prevents UI text from changing (no &amp; showing).
                return raw
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&apos;");
            },

            // If AI violates the 15-word rule, hard-split without rewriting characters.
            splitTextByMaxWordsPreserve(text, maxWords) {
                const words = [...text.matchAll(/\S+/g)];
                if (words.length <= maxWords) return [text];

                const parts = [];
                let cursor = 0;

                for (let i = 0; i < words.length; i += maxWords) {
                    const nextWord = words[i + maxWords];
                    const cutEnd = nextWord ? nextWord.index : text.length;
                    parts.push(text.slice(cursor, cutEnd));
                    cursor = cutEnd;
                }
                return parts.filter(p => p.replace(/\s/g, '').length > 0);
            },

            countWords(text) {
                const m = text.match(/\S+/g);
                return m ? m.length : 0;
            },

            // =========================
            // AI: start -> generate -> segment into <=15 word sentences
            // =========================
            async start() {
                const input = document.getElementById('topic-input');
                const topic = (input?.value || "").trim();
                if (!topic) return;

                this.isActive = true;
                this.updateUI('generating');
                this.log("Generating lesson content for: " + topic, "info");

                try {
                    const response = await this.callAI(topic);
                    const ssmlBlock = response.choices?.[0]?.message?.content || "";
                    const queue = this.segmentSSMLToQueue(ssmlBlock);

                    this.queue = queue;
                    this.log(`Generation complete! ${queue.length} sentences ready.`, "success");
                    this.updateUI('ready');

                } catch (e) {
                    this.log("Error: " + e.message, "error");
                    this.stop();
                }
            },

            queueStory() {
                const input = document.getElementById('story-input');
                const story = input ? input.value : "";
                if (!story.trim()) return;

                this.isActive = true;
                this.updateUI('generating');
                this.log("Chunking story by periods (.) with zero rewriting...", "info");

                try {
                    const chunks = this.splitStoryByPeriod(story);

                    this.queue = chunks.map(chunk => {
                        const ssml = `<speak>${this.escapeForSSML(chunk)}</speak>`;
                        return { text: chunk, ssml };
                    });

                    this.log(`Story queued! ${this.queue.length} chunks ready.`, "success");
                    this.updateUI('ready');
                } catch (e) {
                    this.log("Story chunk error: " + e.message, "error");
                    this.stop();
                }
            },

            segmentSSMLToQueue(ssml) {
                // Remove outer <speak> tags if present
                let content = (ssml || "").replace(/<\/?speak[^>]*>/gi, '').trim();
                if (!content) return [];

                // Prefer <s> sentence tags (we enforce this in the prompt)
                const sMatches = content.match(/<s[^>]*>[\s\S]*?<\/s>/gi);
                let segments = [];

                if (sMatches && sMatches.length) {
                    segments = sMatches.map(s => s.trim()).filter(Boolean);
                } else {
                    // Fallback: split by punctuation boundaries
                    segments = content.split(/(?<=[.!?])\s+(?![^<]*>)/g).map(s => s.trim()).filter(Boolean);
                }

                const queue = [];

                for (const seg of segments) {
                    const wrapped = `<speak>${seg}</speak>`;
                    const text = seg.replace(/<[^>]*>/g, '').trim();
                    if (!text) continue;

                    const wc = this.countWords(text);

                    // Hard guarantee <=15 words per chunk
                    if (wc > 15) {
                        this.log(`AI sentence exceeded 15 words (${wc}). Hard-splitting.`, "warning");

                        const parts = this.splitTextByMaxWordsPreserve(text, 15);
                        for (const part of parts) {
                            queue.push({
                                text: part,
                                ssml: `<speak>${this.escapeForSSML(part)}</speak>`
                            });
                        }
                    } else {
                        queue.push({ text, ssml: wrapped });
                    }
                }

                return queue;
            },

            startBroadcast() {
                this.log("Starting live broadcast...", "success");
                this.updateUI('broadcasting');
                this.runLoop();
            },

            setTopic(topic) {
                const input = document.getElementById('topic-input');
                input.value = topic;
                input.focus();
            },

            stop() {
                this.isActive = false;
                if (this.interval) clearTimeout(this.interval);
                this.queue = [];
                this.releaseKeepAlive();
                this.updateUI('idle');
                this.log("Broadcast stopped.", "warning");
            },

            async callAI(topic) {
                const systemPrompt = `You are "LiveClass Composer": a well-researched expert teacher who speaks naturally, but writes in a translation-stable way.

GOAL
Generate spoken teaching text for a live class or tutorial based on a structured request.

OUTPUT (STRICT)
Return ONLY valid SSML. No JSON. No headings. No bullet points. No preamble.
Wrap everything in ONE <speak>...</speak>.
Wrap EVERY sentence in <s>...</s>.
Each <s> must contain exactly ONE sentence.

CRITICAL LENGTH RULE (NON-NEGOTIABLE)
- EVERY sentence must be 15 words MAXIMUM.
- Count words as space-separated tokens.
- If a sentence would exceed 15 words, rewrite it shorter (do NOT continue long).

NO CENSORING (STRICT)
- Do NOT mask words. No asterisks. No "bleep". No partial redactions.
- If a word is used, output it verbatim.

TRANSLATION-STABLE WRITING RULES (NON-NEGOTIABLE)
1) NO idioms, NO puns, NO metaphors that require interpretation.
2) Prefer concrete nouns over pronouns. Avoid vague ‚Äúit/they/this/that‚Äù.
3) One idea per sentence.
4) Keep technical terms consistent. Do not rename the same concept later.
5) Keep numbers, units, and proper nouns unchanged.

CARTESIA SSML RULES (STRICT)
- Use <break time="300ms"/> to <break time="800ms"/> for natural thinking pauses.
- Put any <break/> inside the SAME <s> sentence it belongs to, usually at the end.
- Occasional word repetition is allowed, but still respect 15-word max.
- Keep fillers rare (max 6 total): ‚Äúum‚Äù, ‚Äúuh‚Äù, ‚Äúokay‚Äù, ‚Äúright‚Äù, in the target language.
- Do NOT include markdown, code fences, or metadata.

LANGUAGE LOCK (CRITICAL)
- TEACHER_LANGUAGE defines your language.
- Every word, filler, hesitation, and explanation MUST be in ${this.session.lang || 'English'}.
- If TEACHER_LANGUAGE = Dutch (nl-BE), you speak natural Belgian Dutch.
- If TEACHER_LANGUAGE = English, you speak natural conversational English.
- Never mix languages unless that language itself is mixed.

STRUCTURE (ALL SENTENCES MUST FOLLOW 15-WORD MAX)
1) Hook (2 sentences)
2) Core explanation (6‚Äì10 sentences)
3) One brief student question moment (literal pattern: "Okay, quick question from a student: <question>.")
4) Practical example (3‚Äì5 sentences)
5) Wrap-up + invitation for questions (2‚Äì3 sentences)

SAFETY (MINIMUM)
No explicit sexual content. No self-harm content. No hate. No illegal instructions.`;

                const res = await fetch(CONFIG.MOONSHOT_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "kimi-k2-0711-preview",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Please explain this topic: ${topic}` }
                        ],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error("Moonshot API failed: " + res.statusText);
                return res.json();
            },

            initKeepAlive() {
                // 1. Wake Lock
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen')
                        .then(lock => { this.wakeLock = lock; })
                        .catch(e => console.log('Wake Lock Error:', e));
                }

                // 2. Silent Audio Hack for Background Execution
                if (!this.silentAudio) {
                    this.silentAudio = new Audio();
                    // 1s of silence base64
                    this.silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
                    this.silentAudio.loop = true;
                    this.silentAudio.volume = 0; // Silent
                }
                this.silentAudio.play().catch(() => { });
            },

            releaseKeepAlive() {
                if (this.wakeLock) {
                    this.wakeLock.release().then(() => { this.wakeLock = null; });
                }
                if (this.silentAudio) {
                    this.silentAudio.pause();
                }
            },

            runLoop() {
                if (this.interval) clearInterval(this.interval);

                // Random delay between 3000ms and 4000ms
                const delay = Math.floor(Math.random() * 1000) + 3000;

                // Start Keep-Alive (WakeLock + Audio)
                this.initKeepAlive();

                this.interval = setTimeout(() => {
                    if (!this.isActive || this.queue.length === 0) {
                        this.stop();
                        return;
                    }

                    const item = this.queue.shift(); // {text, ssml}
                    this.broadcast(item);

                    // Recursive call for next chunk
                    this.runLoop();
                }, delay);
            },

            broadcast(item) {
                const payload = (typeof item === "string")
                    ? { ssml: item, text: item.replace(/<[^>]*>/g, '').trim() }
                    : item;

                push(ref(this.db, `chats/${this.session.room}/messages`), {
                    text: payload.text,       // EXACT visible text (story stays unchanged)
                    ssml: payload.ssml,       // SSML for TTS
                    lang: this.session.lang,
                    senderName: "AI Teacher",
                    senderId: "ai-generator",
                    timestamp: Date.now()
                });

                this.logLatency(`Sent: ${payload.text.substring(0, 20)}...`);
                this.logLatency(`Sent: ${payload.text.substring(0, 20)}...`);
                this.log(`Sent: ${payload.text.substring(0, 50)}...`, "info");
            },

            logLatency(msg) {
                const now = new Date();
                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
                const logEl = document.getElementById('latency-log');
                if (!logEl) return;

                const entry = document.createElement('span');
                entry.innerText = `[${time}] ${msg}`;
                entry.className = "opacity-80 border-r border-white/20 pr-2 mr-2";

                logEl.appendChild(entry);
                logEl.scrollLeft = logEl.scrollWidth;
                if (logEl.children.length > 50) logEl.firstChild.remove();
            },

            updateUI(state) {
                const startBtn = document.getElementById('start-btn');
                const broadcastBtn = document.getElementById('broadcast-btn');
                const stopBtn = document.getElementById('stop-btn');
                const statusBadge = document.getElementById('status-badge');
                const statusText = document.getElementById('status-text');
                const topicInput = document.getElementById('topic-input');
                const storyInput = document.getElementById('story-input');
                const visualizer = statusBadge.querySelector('.visualizer');

                // Helper to set badge style
                const setBadge = (mode) => {
                    if (mode === 'live') {
                        statusBadge.classList.replace('border-gray-200', 'border-emerald-200');
                        statusBadge.classList.replace('bg-white', 'bg-emerald-50');
                        statusBadge.classList.replace('text-gray-600', 'text-emerald-700');
                        visualizer.classList.add('speaking');
                        visualizer.classList.remove('opacity-50');
                        statusText.textContent = "Live Broadcast Active";
                    } else {
                        statusBadge.classList.replace('border-emerald-200', 'border-gray-200');
                        statusBadge.classList.replace('bg-emerald-50', 'bg-white');
                        statusBadge.classList.replace('text-emerald-700', 'text-gray-600');
                        visualizer.classList.remove('speaking');
                        visualizer.classList.add('opacity-50');
                        statusText.textContent = "Connected to Classroom";
                    }
                };

                switch (state) {
                    case 'generating':
                        startBtn.classList.remove('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.add('hidden');
                        startBtn.disabled = true;
                        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        startBtn.innerHTML = '<div class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all"><i class="fa-solid fa-circle-notch fa-spin text-xl"></i><span class="text-sm md:text-base font-black tracking-widest uppercase">Planning...</span></div>';
                        if (topicInput) topicInput.disabled = true;
                        if (storyInput) storyInput.disabled = true;
                        setBadge('idle');
                        break;

                    case 'ready':
                        startBtn.classList.add('hidden');
                        broadcastBtn.classList.remove('hidden');
                        stopBtn.classList.add('hidden');
                        if (topicInput) topicInput.disabled = true;
                        if (storyInput) storyInput.disabled = true;
                        this.log("Review correct? Click BROADCAST to start.", "info");
                        setBadge('idle');
                        break;

                    case 'broadcasting':
                        startBtn.classList.add('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        if (topicInput) topicInput.disabled = true;
                        if (storyInput) storyInput.disabled = true;
                        setBadge('live');
                        break;

                    default: // idle
                        startBtn.classList.remove('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.add('hidden');
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        if (topicInput) topicInput.disabled = false;
                        if (storyInput) storyInput.disabled = false;
                        setBadge('idle');

                        // Re-render primary button label based on tab
                        this.renderPrimaryButton();
                }
            },

            log(msg, type) {
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl text-xs font-medium animate-slide-up ${type === 'success' ? 'bg-green-50 text-green-700' :
                    type === 'error' ? 'bg-red-50 text-red-700' :
                        type === 'warning' ? 'bg-yellow-50 text-yellow-700' :
                            'bg-blue-50 text-blue-700'
                    }`;
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                const container = document.getElementById('log');
                container.prepend(div);
            }
        };

        Generator.init();
    </script>

    <!-- Latency Monitor Log -->
    <div id="latency-log"
        class="fixed bottom-0 left-0 w-full h-auto max-h-[24px] bg-black/90 text-green-400 text-[8px] font-mono leading-none flex items-center gap-4 px-2 overflow-x-auto whitespace-nowrap z-[9999] pointer-events-none">
    </div>
</body>

</html>
