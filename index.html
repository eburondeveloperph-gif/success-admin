<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./pwa_icon.png">
    <link rel="apple-touch-icon" href="./pwa_icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Succes Class - Real-time Translation & Hybrid Learning</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts: Inter (Premium, clean sans-serif) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky Blue
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        accent: {
                            500: '#8b5cf6', // Violet
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Premium Base Styles --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(12px);
            --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --shadow-hard: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e0f2fe 100%);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #1f2937;
        }

        /* VAD Visualizer Bars */
        .vad-bar {
            width: 4px;
            background-color: #cbd5e1;
            border-radius: 999px;
            transition: height 0.1s ease, background-color 0.2s ease;
            height: 4px;
        }
        .vad-bar.active {
            background-color: #ef4444; /* Red when talking */
        }

        /* Input Reset & Styling */
        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .input-glass:focus {
            background: #ffffff;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.01);
            outline: none;
        }

        /* Buttons */
        .btn-modern {
            transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn-modern:active {
            transform: scale(0.97);
        }

        /* Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        .message-bubble {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s;
            transform-origin: bottom left;
        }

        .mic-active-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Student approved / speaking ring (GREEN) */
        .mic-active-ring-green {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            animation: pulse-ring-green 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        /* Animations */
        .view-transition {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .view-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            inset: 0;
            transform: scale(0.98);
            z-index: -1;
        }

        .view-active {
            opacity: 1;
            pointer-events: auto;
            position: relative;
            transform: scale(1);
            z-index: 10;
        }
    </style>
</head>

<body class="antialiased text-gray-800">

    <!-- Toast Container -->
    <div id="toast-container"
        class="fixed top-4 left-0 right-0 z-50 pointer-events-none flex flex-col items-center gap-2 p-4"></div>

    <!-- MAIN APP CONTAINER -->
    <main id="app"
        class="relative w-full h-full max-w-lg mx-auto bg-white/50 shadow-2xl overflow-hidden md:max-w-none md:w-full md:h-full md:my-0 md:rounded-none md:border-0 backdrop-blur-3xl">

        <!-- ================= VIEW: TEACHER LOBBY (QR) ================= -->
        <section id="view-lobby" class="view-hidden w-full h-full flex flex-col bg-white text-center p-8">
            <div class="flex-1 flex flex-col items-center justify-center space-y-8 animate-slide-up">
                <h2 class="text-2xl font-bold text-gray-900">Classroom Ready</h2>

                <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 relative">
                    <div class="absolute inset-0 bg-blue-500/5 rounded-3xl blur-xl -z-10"></div>
                    <!-- QR Placeholder -->
                    <div
                        class="w-48 h-48 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 text-6xl shadow-inner mb-4 border border-blue-100">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Room Code</p>
                        <p id="lobby-code" class="text-4xl font-mono font-black text-blue-600 tracking-widest">----</p>
                    </div>
                </div>

                <p class="text-gray-500 max-w-xs mx-auto text-sm">Share this code with students to let them join the
                    conversation.</p>
            </div>

            <button onclick="App.startSession()"
                class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 flex items-center justify-center gap-3 animate-slide-up">
                <span>Start Session</span>
                <i class="fa-solid fa-play"></i>
            </button>
        </section>

        <!-- ================= VIEW: STUDENT ================= -->
        <section id="view-student" class="view-hidden w-full h-full flex flex-col bg-white">
            <!-- Navbar -->
            <header
                class="h-16 px-6 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <button onclick="App.logout()" title="Logout"
                        class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-gray-900 transition-colors">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                    </button>
                    <div>
                        <h2 id="student-name-display"
                            class="font-bold text-gray-900 leading-tight text-sm text-truncate max-w-[120px]">Student
                        </h2>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Receiving:</span>
                            <span id="student-lang-badge"
                                class="text-[10px] font-black uppercase text-blue-600">EN</span>
                        </div>
                    </div>
                </div>
                <!-- Status & Audio Toggle -->
                <div class="flex items-center gap-4">
                    <a href="student-history.html" title="View My History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </a>
                    <button id="tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
            </header>

            <!-- Chat Stream -->
            <div id="student-stream"
                class="flex-1 overflow-y-auto p-6 space-y-6 pb-32 bg-gray-50/50 custom-scrollbar scroll-smooth">
                <!-- Welcome Message -->
                <div class="text-center py-10 opacity-60">
                    <div
                        class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-xl">
                        <i class="fa-solid fa-ear-listen"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-500">Connected to <span
                            class="font-mono text-gray-700 font-bold" id="student-room-code">...</span></p>
                    <p class="text-xs text-gray-400 mt-1">Listening for speech...</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent z-20">
                <div class="flex items-center justify-between gap-4">
                    <!-- Reactions -->
                    <div class="flex gap-3">
                        <button onclick="App.sendReaction('üëç')"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">üëç</button>
                        <button onclick="App.sendReaction('‚ù§Ô∏è')"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">‚ù§Ô∏è</button>
                        <button id="raise-hand-btn" onclick="App.sendRaiseHandRequest()" title="Raise Hand"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50 hover:scale-110">
                            <i class="fa-solid fa-hand"></i>
                        </button>
                        <button id="chat-btn-student" onclick="App.openChatModal()" title="Chat"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50 hover:scale-110">
                            <i class="fa-solid fa-comment-dots"></i>
                        </button>
                    </div>

                    <!-- Request Mic / Speak button (REPLACES Raise Hand) -->
                    <button id="mic-btn-student" onclick="App.handleStudentMicAction()"
                        class="btn-modern h-12 px-6 rounded-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold shadow-lg shadow-blue-500/20 flex items-center gap-2">
                        <i id="mic-icon-student" class="fa-solid fa-microphone-lines"></i>
                        <span id="mic-label-student">Request Mic</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= VIEW: TEACHER (DASHBOARD) ================= -->
        <section id="view-teacher" class="view-hidden w-full h-full flex flex-col bg-slate-50">
            <!-- Header -->
            <header
                class="h-16 px-6 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-30">
                <div class="flex items-center gap-3">
                    <button onclick="App.logout()" title="Logout"
                        class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    <div>
                        <h1 class="font-bold text-gray-900 text-sm">Teacher Panel</h1>
                        <div class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-100 px-1.5 rounded transition-colors"
                            onclick="App.copyCode()">
                            <p class="text-xs text-gray-500 font-mono tracking-wider " id="teacher-code-display">CODE
                            </p>
                            <i class="fa-regular fa-copy text-[10px] text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <a href="teacher-agent.html" title="AI Assistant"
                        class="text-gray-400 hover:text-purple-500 transition-colors">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </a>
                    <a href="history.html" title="View History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </a>
                    <button id="teacher-tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="teacher-tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <!-- Mic Toggle -->
                    <button id="mic-btn" onclick="App.toggleMic()" title="Toggle Microphone"
                        class="btn-modern relative w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition-all hover:bg-gray-200">
                        <i class="fa-solid fa-microphone-slash text-sm"></i>
                    </button>
                    <!-- Notifications -->
                    <button id="notif-btn" onclick="App.toggleModal('notifications')" title="Notifications"
                        class="relative text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-bell text-lg"></i>
                        <span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center">0</span>
                    </button>
                </div>
            </header>

            <main class="flex-1 p-4 grid grid-rows-2 gap-4 h-[calc(100%-4rem)]">
                <!-- Live Transcript Area with VAD Visualizer -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative group">
                    <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-wave-square text-blue-500"></i> Live Audio (VAD Enabled)
                        </h3>
                        
                        <!-- VAD Visualizer Meter -->
                        <div id="vad-meter" class="flex gap-1 h-3 items-end">
                             <div class="vad-bar"></div>
                             <div class="vad-bar"></div>
                             <div class="vad-bar"></div>
                             <div class="vad-bar"></div>
                             <div class="vad-bar"></div>
                        </div>
                    </div>

                    <div id="teacher-transcript-container"
                        class="flex-1 p-5 overflow-y-auto custom-scrollbar bg-white relative text-xl font-medium leading-relaxed">
                        <!-- Finalized Buffer -->
                        <span id="teacher-buffer" class="text-gray-800 transition-all"></span>
                        <!-- Interim (Gray) -->
                        <span id="teacher-interim" class="text-gray-300 italic"></span>
                    </div>
                </div>

                <!-- Incoming Questions / Requests / Student Speech -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                    <!-- Tab Header -->
                    <div class="px-4 py-2 bg-gray-50/50 border-b border-gray-100 flex items-center gap-4">
                        <button id="tab-questions-btn" onclick="App.switchTeacherTab('questions')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-blue-100 text-blue-700 transition-colors">
                            <i class="fa-regular fa-comments"></i>
                            Questions
                            <span id="question-count" class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                        </button>
                        <button id="tab-students-btn" onclick="App.switchTeacherTab('students')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-500 hover:bg-gray-100 transition-colors">
                            <i class="fa-solid fa-users"></i>
                            Students
                            <span id="student-count" class="bg-gray-300 text-gray-700 text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                        </button>
                    </div>
                    <!-- Questions Tab Content -->
                    <div id="tab-questions-content" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 custom-scrollbar">
                        <!-- Cards injected here -->
                        <div id="teacher-questions"></div>
                        <div id="teacher-empty" class="text-center py-8 opacity-40">
                            <i class="fa-regular fa-comments text-2xl mb-2 text-gray-400"></i>
                            <p class="text-xs text-gray-500">No questions yet</p>
                        </div>
                    </div>
                    <!-- Students Tab Content -->
                    <div id="tab-students-content" class="hidden flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 custom-scrollbar">
                        <div id="students-list"></div>
                        <div id="students-empty" class="text-center py-8 opacity-40">
                            <i class="fa-solid fa-users text-2xl mb-2 text-gray-400"></i>
                            <p class="text-xs text-gray-500">No students connected yet</p>
                        </div>
                    </div>
                </div>
            </main>
        </section>

        <!-- ================= MODAL: QUESTION ================= -->
        <div id="modal-question" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="modal-backdrop" onclick="App.toggleModal('question')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="modal-panel">
                <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">Ask a Question</h3>
                    <p class="text-sm text-gray-500 mb-6">Your question will be translated for the teacher.</p>

                    <div class="relative mb-6">
                        <input id="q-input" type="text"
                            class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 transition-colors"
                            placeholder="Type your question..."
                            onkeydown="if(event.key === 'Enter') App.sendQuestion()">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="App.toggleModal('question')"
                            class="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
                        <button onclick="App.sendQuestion()"
                            class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-colors">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: CHAT ================= -->
        <div id="modal-chat" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="chat-backdrop" onclick="App.toggleModal('chat')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="chat-panel">
                <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">Send a Chat</h3>
                    <p class="text-sm text-gray-500 mb-6">Your message will be translated for the teacher.</p>

                    <div class="relative mb-6">
                        <input id="chat-input" type="text"
                            class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 transition-colors"
                            placeholder="Type your message..."
                            onkeydown="if(event.key === 'Enter') App.sendStudentChat()">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="App.toggleModal('chat')"
                            class="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
                        <button onclick="App.sendStudentChat()"
                            class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-colors">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: HISTORY ================= -->
        <div id="modal-history" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="history-backdrop" onclick="App.toggleModal('history')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-lg md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="history-panel">
                <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl flex flex-col h-[70vh]">
                    <div
                        class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-3xl border-t-4 border-blue-500">
                        <div>
                            <h3 class="text-xl font-black text-gray-900 leading-none">History</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold uppercase tracking-widest">Session Archive
                            </p>
                        </div>
                        <button onclick="App.toggleModal('history')"
                            class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-900 shadow-sm transition-all active:scale-95">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div id="history-content"
                        class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50 custom-scrollbar">
                        <!-- History items injected here -->
                        <div class="text-center py-20 opacity-30">
                            <i class="fa-solid fa-hourglass-start text-4xl mb-4"></i>
                            <p class="text-sm font-bold">No history available yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: NOTIFICATIONS ================= -->
        <div id="modal-notifications" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="notifications-backdrop" onclick="App.toggleModal('notifications')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="notifications-panel">
                <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl flex flex-col max-h-[60vh]">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-3xl">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-bell text-blue-500"></i>
                            <h3 class="text-lg font-bold text-gray-900">Notifications</h3>
                        </div>
                        <button onclick="App.clearNotifications()" class="text-xs text-gray-400 hover:text-red-500 font-semibold">Clear All</button>
                    </div>

                    <div id="notifications-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                        <div id="notifications-empty" class="text-center py-10 opacity-40">
                            <i class="fa-regular fa-bell-slash text-2xl mb-2 text-gray-400"></i>
                            <p class="text-xs text-gray-500">No notifications yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ================= LOGIC ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Web Speech API initialization
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const SpeechGrammarList = window.SpeechGrammarList || window.webkitSpeechGrammarList;
        const SpeechRecognitionEvent = window.SpeechRecognitionEvent || window.webkitSpeechRecognitionEvent;

        // --- CREDENTIALS ---
        const CREDENTIALS = {
            CARTESIA: "sk_car_yWEX9Mp2LwKju8FXyosGhj",
            CARTESIA_VOICES: {
                "en": "cbaf8084-f009-4838-a096-07ee2e6612b1", // Cathy
                "hi": "faf0731e-dfb9-4cfc-8119-259a79b27e12", // Riya
                "es": "5c5ad5e7-1020-476b-8b91-fdcbe9cc313c", // Daniela
                "de": "38aabb6a-f52b-4fb0-a3d1-988518f4dc06", // Alina
                "ar": "002622d8-19d0-4567-a16a-f99c7397c062", // Huda
                "fr": "a8a1eb38-5f15-4c1d-8722-7ac0f329727d", // Calm French Woman
                "ko": "304fdbd8-65e6-40d6-ab78-f9d18b9efdf9", // Jihyun
                "ja": "2b568345-1d48-4047-b25f-7baccf842eb0", // Yumiko
                "pt": "700d1ee3-a641-4018-ba6e-899dcadc9e2b", // Luana
                "ta": "25d2c432-139c-4035-bfd6-9baaabcdd006", // Kavya
                "te": "07bc462a-c644-49f1-baf7-82d5599131be", // Sindhu
                "nl": "9e8db62d-056f-47f3-b3b6-1b05767f9176", // Dutch
                "nl-BE": "9e8db62d-056f-47f3-b3b6-1b05767f9176", // Flemish
                "default": "cbaf8084-f009-4838-a096-07ee2e6612b1"
            },
            CARTESIA_PDICT: {
                "nl-BE": "pdict_TPgLmfbAo9pQoorcetVez8" // Flemish pronunciation
            },
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890abcdef"
            }
        };

        const LANGUAGES = [
            { code: 'nl-BE', name: 'Flemish', flag: 'üáßüá™' },
            { code: 'en', name: 'English', flag: 'üá∫üá∏' },
            { code: 'fr', name: 'French', flag: 'üá´üá∑' },
            { code: 'de', name: 'German', flag: 'üá©üá™' },
            { code: 'es', name: 'Spanish', flag: 'üá™üá∏' },
            { code: 'it', name: 'Italian', flag: 'üáÆüáπ' },
            { code: 'pt', name: 'Portuguese', flag: 'üáµüáπ' },
            { code: 'zh', name: 'Chinese', flag: 'üá®üá≥' },
            { code: 'ja', name: 'Japanese', flag: 'üáØüáµ' },
            { code: 'ko', name: 'Korean', flag: 'üá∞üá∑' }
        ];

        class SuccesApp {
            constructor() {
                this.app = initializeApp(CREDENTIALS.FIREBASE);
                this.db = getDatabase(this.app);

                this.state = {
                    role: null,
                    room: '',
                    name: '',
                    gender: 'Male',
                    lang: 'en',
                    isMicActive: false,      // teacher mic status
                    isTTSActive: false,
                    audioQueue: [],
                    isAudioPlaying: false
                };

                // Teacher Audio State (VAD)
                this.teacherAudio = {
                    recognition: null,
                    audioContext: null,
                    analyser: null,
                    vadInterval: null,
                    lastVoiceTime: Date.now(),
                    finalizedBuffer: "", // Completed sentences waiting to be sent
                    lastSentText: "", // Deduplication check
                    isSpeaking: false,
                    wakeLock: null
                };

                // Student mic/request flow state
                this.student = {
                    requestPending: false,
                    approved: false,
                    recording: false,
                    approvalKey: null,
                    chatRequestPending: false,
                    chatApproved: false,

                    recognition: null,
                    mediaRecorder: null,
                    mediaStream: null,
                    audioChunks: [],
                    finalParts: [],
                    lastInterim: ''
                };

                this.bindAll();
                this.init();
            }

            saveState() {
                localStorage.setItem('orbit_session', JSON.stringify({
                    role: this.state.role,
                    room: this.state.room,
                    name: this.state.name,
                    lang: this.state.lang,
                    currentView: this.state.currentView
                }));
            }

            clearState() {
                localStorage.removeItem('orbit_session');
            }

            bindAll() {
                [
                    'startSession',
                    'logout',
                    'toggleMic',
                    'sendQuestion',
                    'toggleModal',
                    'sendReaction',
                    'toggleTTS',
                    'handleStudentMicAction',
                    'approveMicRequest',
                    'sendRaiseHandRequest',
                    'openChatModal',
                    'sendStudentChat',
                    'approveChatRequest',
                    'switchTeacherTab',
                    'clearNotifications',
                    'copyCode'
                ].forEach(m => this[m] = this[m].bind(this));
            }

            init() {
                window.App = this;

                // Check for session - redirect to auth.html if not logged in
                const saved = localStorage.getItem('orbit_session');
                if (!saved) {
                    window.location.href = 'auth.html';
                    return;
                }

                try {
                    const data = JSON.parse(saved);
                    if (!data.role || !data.room) {
                        window.location.href = 'auth.html';
                        return;
                    }

                    this.state = { ...this.state, ...data };

                    if (this.state.role === 'student' && this.state.room) {
                        this.initStudent();
                        this.switchView(this.state.currentView || 'view-student');
                    } else if (this.state.role === 'teacher' && this.state.room) {
                        if (this.state.currentView === 'view-teacher') {
                            this.initTeacher();
                            this.switchView('view-teacher');
                        } else {
                            document.getElementById('lobby-code').innerText = this.state.room;
                            this.switchView('view-lobby');
                        }
                    }
                } catch (e) {
                    this.clearState();
                    window.location.href = 'auth.html';
                    return;
                }

                this.registerServiceWorker();
            }

            // --- NAVIGATION ---
            switchView(viewId) {
                this.state.currentView = viewId;
                this.saveState();

                document.querySelectorAll('section').forEach(el => {
                    el.classList.remove('view-active');
                    el.classList.add('view-hidden');
                });
                const target = document.getElementById(viewId);
                setTimeout(() => {
                    target.classList.remove('view-hidden');
                    target.classList.add('view-active');
                }, 50);
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('SW registered:', reg.scope))
                        .catch(err => console.log('SW failed:', err));
                }
            }

            toggleModal(type) {
                const modal = document.getElementById(`modal-${type}`);
                const bdId = type === 'history' ? 'history-backdrop' : (type === 'chat' ? 'chat-backdrop' : (type === 'notifications' ? 'notifications-backdrop' : 'modal-backdrop'));
                const panelId = type === 'history' ? 'history-panel' : (type === 'chat' ? 'chat-panel' : (type === 'notifications' ? 'notifications-panel' : 'modal-panel'));
                const bd = document.getElementById(bdId);
                const panel = document.getElementById(panelId);

                if (!modal || !bd || !panel) return;

                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    if (type === 'history') this.loadHistory();
                    setTimeout(() => {
                        bd.style.opacity = '1';
                        panel.style.transform = (window.innerWidth < 768) ? 'translateY(0)' : 'translate(-50%, -50%)';
                    }, 10);
                } else {
                    bd.style.opacity = '0';
                    panel.style.transform = (window.innerWidth < 768) ? 'translateY(100%)' : 'translate(-50%, 0)';
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            async loadHistory() {
                const container = document.getElementById('history-content');
                container.innerHTML = '<div class="text-center py-20 opacity-50"><i class="fa-solid fa-circle-notch animate-spin text-2xl"></i></div>';

                if (!this.state.room) return;

                try {
                    const data = [];
                    // Fetch Messages (Broadcasts)
                    const mSnap = await get(ref(this.db, `chats/${this.state.room}/messages`));
                    if (mSnap.exists()) {
                        mSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'broadcast', ts: s.key });
                        });
                    }

                    // Fetch Questions
                    const qSnap = await get(ref(this.db, `chats/${this.state.room}/questions`));
                    if (qSnap.exists()) {
                        qSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'question', ts: s.key });
                        });
                    }

                    // Fetch Student Responses
                    const rSnap = await get(ref(this.db, `chats/${this.state.room}/studentResponses`));
                    if (rSnap.exists()) {
                        rSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'studentSpeech', ts: s.key });
                        });
                    }

                    // Sort by timestamp
                    data.sort((a, b) => b.ts.localeCompare(a.ts));

                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-center py-20 opacity-30"><p class="text-sm font-bold">No history available</p></div>';
                        return;
                    }

                    container.innerHTML = '';
                    for (const item of data) {
                        if (this.state.role === 'student') {
                            if (item.type === 'broadcast') {
                                const trans = await this.translateText(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, trans, item.text, 'Teacher', 'broadcast');
                            }
                        } else {
                            if (item.type === 'broadcast') {
                                this.renderHistoryItem(container, item.text, item.text, 'You', 'broadcast');
                            } else if (item.type === 'question') {
                                const trans = await this.translateText(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, trans, item.text, item.senderName, 'question');
                            } else if (item.type === 'studentSpeech') {
                                const teacherText = item.textForTeacher || await this.translateText(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, teacherText, item.text, item.senderName, 'question');
                            }
                        }
                    }
                } catch (e) {
                    container.innerHTML = `<p class="text-center text-red-500 text-xs py-10">Error loading history: ${e.message}</p>`;
                }
            }

            renderHistoryItem(container, text, original, sender, type) {
                const div = document.createElement('div');
                const isBroadcast = type === 'broadcast';
                div.className = `p-4 rounded-2xl border ${isBroadcast ? 'bg-white border-gray-100' : 'bg-blue-50/50 border-blue-100'} animate-slide-up`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-black uppercase tracking-tighter ${isBroadcast ? 'text-gray-400' : 'text-blue-500'}">${sender} ‚Ä¢ ${isBroadcast ? 'Broadcast' : 'Entry'}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
                    <p class="text-[10px] text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                container.appendChild(div);
            }

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { info: 'bg-gray-800 text-white', success: 'bg-green-600 text-white', error: 'bg-red-500 text-white' };
                toast.className = `${colors[type]} px-4 py-2 rounded-lg shadow-xl text-sm font-semibold transform transition-all duration-300 translate-y-[-20px] opacity-0 flex items-center gap-2`;
                toast.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : msg;
                container.appendChild(toast);
                requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-10px]');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            startSession() {
                this.initTeacher();
                this.switchView('view-teacher');
            }

            async logout() {
                // Teacher mic cleanup
                if (this.state.isMicActive) await this.stopTeacherAudio();

                // Student mic cleanup
                if (this.student.recording || this.student.approved) {
                    await this.stopStudentCapture(false);
                }

                this.clearState();
                this.state.role = null;
                this.state.room = '';
                this.state.name = '';
                this.state.isMicActive = false;
                window.location.href = 'auth.html';
            }

            // --- TEACHER AUDIO (VAD + Web Speech) ---

            async toggleMic() {
                if (this.state.isMicActive) {
                    this.stopTeacherAudio();
                    this.updateMicUI(false);
                } else {
                    try {
                        await this.startTeacherAudio();
                        this.updateMicUI(true);
                        this.showToast("Mic Active - VAD Enabled", "success");
                    } catch (e) {
                        this.showToast("Mic Error: " + e.message, "error");
                    }
                }
            }

            async startTeacherAudio() {
                this.state.isMicActive = true;
                
                // 1. Setup AudioContext for VAD (Voice Activity Detection)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.teacherAudio.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = this.teacherAudio.audioContext.createMediaStreamSource(stream);
                this.teacherAudio.analyser = this.teacherAudio.audioContext.createAnalyser();
                this.teacherAudio.analyser.fftSize = 512; // Small buffer for fast reaction
                source.connect(this.teacherAudio.analyser);

                // Wake Lock
                if ('wakeLock' in navigator) {
                     try { this.teacherAudio.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
                }

                // 2. Setup Speech Recognition
                if (!SpeechRecognition) throw new Error("Browser not supported");
                this.teacherAudio.recognition = new SpeechRecognition();
                this.teacherAudio.recognition.continuous = true;
                this.teacherAudio.recognition.interimResults = true;
                this.teacherAudio.recognition.lang = this.state.lang || 'en-US';
                
                this.teacherAudio.recognition.onresult = (event) => {
                    let interim = "";
                    let finalChunk = "";

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalChunk += event.results[i][0].transcript;
                        } else {
                            interim += event.results[i][0].transcript;
                        }
                    }

                    // Append finalized chunks to our buffer
                    if (finalChunk) {
                        const cleaned = finalChunk.trim();
                        // Prevent instant dupes from API
                        if (cleaned) {
                            this.teacherAudio.finalizedBuffer += " " + cleaned;
                        }
                    }
                    
                    // Update UI
                    this.updateUIBuffer(interim);
                };

                this.teacherAudio.recognition.onend = () => {
                    if (this.state.isMicActive) {
                         // Restart if stopped unexpectedly
                        try { this.teacherAudio.recognition.start(); } catch(e){}
                    }
                };

                this.teacherAudio.recognition.start();

                // 3. Start VAD Loop
                this.startVADLoop();
            }

            stopTeacherAudio() {
                this.state.isMicActive = false;
                if (this.teacherAudio.recognition) this.teacherAudio.recognition.stop();
                if (this.teacherAudio.audioContext) this.teacherAudio.audioContext.close();
                if (this.teacherAudio.vadInterval) clearInterval(this.teacherAudio.vadInterval);
                if (this.teacherAudio.wakeLock) this.teacherAudio.wakeLock.release();
                
                // Flush remaining text
                this.flushBuffer();
            }

            startVADLoop() {
                const bufferLength = this.teacherAudio.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const visualBars = document.querySelectorAll('.vad-bar');

                this.teacherAudio.vadInterval = setInterval(() => {
                    this.teacherAudio.analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate Volume
                    let sum = 0;
                    for(let i = 0; i < bufferLength; i++) sum += dataArray[i];
                    const average = sum / bufferLength;

                    // Visualizer
                    const normalized = Math.min(100, average * 2); 
                    visualBars.forEach((bar, idx) => {
                        bar.style.height = (4 + (normalized * ((idx+1)*0.2))) + 'px';
                        bar.classList.toggle('active', average > 10);
                    });

                    // VAD Logic: Threshold = 15
                    if (average > 15) {
                        this.teacherAudio.lastVoiceTime = Date.now();
                        this.teacherAudio.isSpeaking = true;
                    } else {
                        // Silence
                        const timeSinceVoice = Date.now() - this.teacherAudio.lastVoiceTime;
                        if (timeSinceVoice > 1500 && this.teacherAudio.isSpeaking) {
                            // 1.5s of silence detected -> End of sentence
                            this.teacherAudio.isSpeaking = false;
                            this.flushBuffer();
                        }
                    }
                }, 100);
            }

            flushBuffer() {
                const text = this.teacherAudio.finalizedBuffer.trim();
                if (!text) return;
                
                // Anti-Duplication: Don't send if exactly same as last time
                if (text === this.teacherAudio.lastSentText) {
                    this.teacherAudio.finalizedBuffer = "";
                    this.updateUIBuffer();
                    return;
                }

                // Send
                this.broadcastMessage(text);
                
                // Reset
                this.teacherAudio.lastSentText = text;
                this.teacherAudio.finalizedBuffer = "";
                this.updateUIBuffer();
            }

            updateUIBuffer(interim = "") {
                const bufferEl = document.getElementById('teacher-buffer');
                const interimEl = document.getElementById('teacher-interim');
                if (bufferEl) bufferEl.innerText = this.teacherAudio.finalizedBuffer;
                if (interimEl) interimEl.innerText = interim;
            }

            updateMicUI(active) {
                const btn = document.getElementById('mic-btn');
                if (!btn) return;
                if (active) {
                    btn.classList.add('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                } else {
                    btn.classList.remove('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-sm"></i>';
                }
            }

            broadcastMessage(text) {
                push(ref(this.db, `chats/${this.state.room}/messages`), {
                    text: text,
                    lang: this.state.lang,
                    senderName: this.state.name,
                    timestamp: Date.now()
                });
            }

            // --- STUDENT MIC LOGIC ---

            updateStudentMicButton() {
                const btn = document.getElementById('mic-btn-student');
                const icon = document.getElementById('mic-icon-student');
                const label = document.getElementById('mic-label-student');
                if (!btn || !icon || !label) return;

                btn.disabled = false;
                btn.className = "btn-modern h-12 px-6 rounded-full font-semibold shadow-lg flex items-center gap-2";

                if (this.state.role !== 'student') {
                    icon.className = "fa-solid fa-microphone-lines";
                    label.textContent = "Request Mic";
                    return;
                }

                if (this.student.recording) {
                    btn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'mic-active-ring-green');
                    icon.className = "fa-solid fa-microphone";
                    label.textContent = "Stop & Send";
                } else if (this.student.approved) {
                    btn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'mic-active-ring-green');
                    icon.className = "fa-solid fa-microphone";
                    label.textContent = "Speaking...";
                } else if (this.student.requestPending) {
                    btn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'opacity-70', 'cursor-not-allowed', 'text-white');
                    btn.disabled = true;
                    icon.className = "fa-solid fa-hourglass-half";
                    label.textContent = "Requested";
                } else {
                    btn.classList.add('bg-[#0ea5e9]', 'hover:bg-[#0284c7]', 'text-white');
                    icon.className = "fa-solid fa-microphone-lines";
                    label.textContent = "Request Mic";
                }
            }

            async handleStudentMicAction() {
                if (this.state.role !== 'student' || !this.state.room) return;

                if (this.student.recording) {
                    await this.stopStudentCapture(true);
                    return;
                }
                if (this.student.approved && !this.student.recording) {
                    await this.startStudentCapture();
                    return;
                }
                if (this.student.requestPending) return;
                await this.sendStudentMicRequest();
            }

            async sendStudentMicRequest() {
                try {
                    this.student.requestPending = true;
                    this.updateStudentMicButton();
                    await push(ref(this.db, `chats/${this.state.room}/requests`), {
                        senderName: this.state.name,
                        lang: this.state.lang,
                        timestamp: Date.now()
                    });
                    this.showToast("Microphone request sent", "success");
                } catch (e) {
                    this.student.requestPending = false;
                    this.updateStudentMicButton();
                    this.showToast("Error: " + e.message, "error");
                }
            }

            async startStudentCapture() {
                if (this.student.recording) return;

                try {
                    this.student.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.student.recognition = new SpeechRecognition();
                    this.student.recognition.continuous = true;
                    this.student.recognition.interimResults = true;
                    this.student.recognition.lang = this.state.lang || 'en-US';

                    this.student.finalParts = [];
                    this.student.audioChunks = [];

                    // Setup MediaRecorder for audio blob
                    this.student.mediaRecorder = new MediaRecorder(this.student.mediaStream);
                    this.student.mediaRecorder.ondataavailable = e => {
                         if (e.data.size > 0) this.student.audioChunks.push(e.data);
                    };

                    this.student.recognition.onresult = (event) => {
                        let final = "";
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) final += event.results[i][0].transcript;
                        }
                        if (final) this.student.finalParts.push(final.trim());
                    };

                    this.student.recognition.start();
                    this.student.mediaRecorder.start(200);
                    this.student.recording = true;
                    this.updateStudentMicButton();
                    this.showToast("Recording...", "info");
                } catch (e) {
                    await this.stopStudentCapture(false);
                    this.showToast("Mic Error", "error");
                }
            }

            async stopStudentCapture(submit = true) {
                if (this.student.recognition) this.student.recognition.stop();
                
                // Stop Recorder & Stream
                const recorder = this.student.mediaRecorder;
                if (recorder && recorder.state !== 'inactive') {
                    await new Promise(r => {
                        recorder.onstop = r;
                        recorder.stop();
                    });
                }
                if (this.student.mediaStream) this.student.mediaStream.getTracks().forEach(t => t.stop());

                const finalText = this.student.finalParts.join(" ").trim();
                const mimeType = recorder ? recorder.mimeType : 'audio/webm';

                if (submit && finalText) {
                    let audioBase64 = null;
                    const blob = new Blob(this.student.audioChunks, { type: mimeType });
                    if (blob.size <= 1500000) audioBase64 = await this.blobToBase64(blob);

                    let textForTeacher = await this.translateText(finalText, this.state.lang, 'en'); // default to EN if unknown

                    await push(ref(this.db, `chats/${this.state.room}/studentResponses`), {
                        senderName: this.state.name,
                        lang: this.state.lang,
                        text: finalText,
                        textForTeacher: textForTeacher,
                        audioBase64: audioBase64,
                        audioMimeType: mimeType,
                        timestamp: Date.now()
                    });
                    this.showToast("Sent!", "success");
                }

                // Reset
                this.student.recording = false;
                this.student.approved = false;
                this.student.requestPending = false;
                this.updateStudentMicButton();
            }

            async blobToBase64(blob) {
                return new Promise((resolve) => {
                    const r = new FileReader();
                    r.onloadend = () => resolve(r.result.split(',')[1]);
                    r.readAsDataURL(blob);
                });
            }

            // --- TEACHER APPROVAL LOGIC ---

            initTeacher() {
                document.getElementById('teacher-code-display').innerText = this.state.room;
                
                // Mic Requests
                onChildAdded(ref(this.db, `chats/${this.state.room}/requests`), (snap) => {
                    this.renderMicRequestCard(snap.key, snap.val());
                    this.incrementQuestionCount();
                });

                // Hand Raises
                onChildAdded(ref(this.db, `chats/${this.state.room}/handRaises`), (snap) => {
                    this.renderHandRaiseCard(snap.key, snap.val());
                    this.incrementQuestionCount();
                });

                // Student Responses
                onChildAdded(ref(this.db, `chats/${this.state.room}/studentResponses`), async (snap) => {
                    const r = snap.val();
                    const text = r.textForTeacher || await this.translateText(r.text, r.lang, this.state.lang);
                    this.renderStudentSpeechCard({
                        sender: r.senderName, text: text, original: r.text,
                        audioBase64: r.audioBase64, audioMimeType: r.audioMimeType
                    });
                    this.incrementQuestionCount();
                });

                // Questions
                onChildAdded(ref(this.db, `chats/${this.state.room}/questions`), async (snap) => {
                    const q = snap.val();
                    const text = await this.translateText(q.text, q.lang, this.state.lang);
                    this.renderQuestionCard({ kind: 'question', sender: q.senderName, text, original: q.text });
                    this.incrementQuestionCount();
                });

                // Student List
                onChildAdded(ref(this.db, `chats/${this.state.room}/students`), (snap) => {
                    this.renderStudentListItem(snap.val());
                    this.updateStudentCount();
                });
            }

            incrementQuestionCount() {
                const count = document.getElementById('question-count');
                if (count) count.innerText = String((parseInt(count.innerText) || 0) + 1);
            }
            updateStudentCount() {
                const list = document.getElementById('students-list');
                const count = document.getElementById('student-count');
                if (list && count) count.innerText = list.children.length;
            }

            renderMicRequestCard(key, req) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-emerald-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-emerald-300 transition-colors";
                card.innerHTML = `
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded uppercase">${req.senderName}</span>
                                <span class="text-[10px] font-black text-emerald-600 uppercase tracking-tight">Mic Request</span>
                            </div>
                        </div>
                        <button class="approve-btn btn-modern px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold">Approve</button>
                    </div>
                `;
                card.querySelector('.approve-btn').onclick = () => {
                    this.approveMicRequest(key, req);
                    card.remove();
                };
                list.prepend(card);
            }

            renderHandRaiseCard(key, req) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-amber-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-amber-300 transition-colors";
                card.innerHTML = `
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded uppercase">${req.senderName}</span>
                                <span class="text-[10px] font-black text-amber-600 uppercase tracking-tight">Raised Hand</span>
                            </div>
                        </div>
                        <button class="approve-btn btn-modern px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold">Approve</button>
                    </div>
                `;
                card.querySelector('.approve-btn').onclick = () => {
                    this.approveChatRequest(key, req);
                    card.remove();
                };
                list.prepend(card);
            }

            async approveMicRequest(key, req) {
                await push(ref(this.db, `chats/${this.state.room}/approvedSpeakers`), { speakerName: req.senderName });
                await remove(ref(this.db, `chats/${this.state.room}/requests/${key}`));
                this.showToast(`Approved ${req.senderName}`, "success");
            }
            async approveChatRequest(key, req) {
                await push(ref(this.db, `chats/${this.state.room}/approvedChat`), { speakerName: req.senderName });
                await remove(ref(this.db, `chats/${this.state.room}/handRaises/${key}`));
                this.showToast(`Approved Chat: ${req.senderName}`, "success");
            }

            renderStudentSpeechCard({ sender, text, original, audioBase64, audioMimeType }) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-purple-100 p-3 rounded-xl shadow-sm animate-slide-up";
                card.innerHTML = `
                    <div class="flex justify-between mb-1 gap-2"><span class="text-[10px] font-bold bg-purple-50 text-purple-700 px-1.5 py-0.5 rounded uppercase">${sender}</span></div>
                    <p class="text-sm font-semibold text-gray-800">${text}</p>
                    <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
                    ${audioBase64 ? `<button class="play-btn mt-2 bg-purple-600 text-white px-3 py-1 text-xs rounded">Play Audio</button>` : ''}
                `;
                if(audioBase64) {
                    card.querySelector('.play-btn').onclick = () => {
                        const audio = new Audio("data:" + audioMimeType + ";base64," + audioBase64);
                        audio.play();
                    };
                }
                list.prepend(card);
            }

            renderQuestionCard({ kind, sender, text, original }) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-blue-100 p-3 rounded-xl shadow-sm animate-slide-up";
                card.innerHTML = `
                    <div class="flex justify-between mb-1"><span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${sender}</span></div>
                    <p class="text-sm font-semibold text-gray-800">${text}</p>
                    <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                list.prepend(card);
            }

            renderStudentListItem(student) {
                const list = document.getElementById('students-list');
                const card = document.createElement('div');
                card.className = "bg-white border border-gray-100 p-3 rounded-xl shadow-sm flex items-center justify-between";
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">${student.name.charAt(0)}</div>
                        <p class="text-sm font-semibold">${student.name}</p>
                    </div>
                `;
                list.appendChild(card);
            }

            // --- STUDENT UI LOGIC ---
            
            updateChatControls() {
                const raiseBtn = document.getElementById('raise-hand-btn');
                const chatBtn = document.getElementById('chat-btn-student');
                if(!raiseBtn || !chatBtn) return;
                
                chatBtn.disabled = !this.student.chatApproved;
                if(this.student.chatApproved) chatBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                else chatBtn.classList.add('opacity-60', 'cursor-not-allowed');

                if(this.student.chatRequestPending) {
                    raiseBtn.classList.add('bg-amber-500', 'opacity-70');
                    raiseBtn.disabled = true;
                }
            }

            initStudent() {
                document.getElementById('student-name-display').innerText = this.state.name;
                document.getElementById('student-lang-badge').innerText = this.state.lang.toUpperCase();
                document.getElementById('student-room-code').innerText = this.state.room;
                this.updateStudentMicButton();
                this.updateChatControls();

                // Approvals
                onChildAdded(ref(this.db, `chats/${this.state.room}/approvedSpeakers`), (snap) => {
                    if(snap.val().speakerName === this.state.name) {
                        this.student.approved = true;
                        this.student.requestPending = false;
                        this.updateStudentMicButton();
                        this.startStudentCapture();
                    }
                });
                onChildAdded(ref(this.db, `chats/${this.state.room}/approvedChat`), (snap) => {
                    if(snap.val().speakerName === this.state.name) {
                        this.student.chatApproved = true;
                        this.student.chatRequestPending = false;
                        this.updateChatControls();
                        this.showToast("Chat Approved!", "success");
                    }
                });

                // Messages
                onChildAdded(ref(this.db, `chats/${this.state.room}/messages`), async (snap) => {
                    const msg = snap.val();
                    const text = await this.translateText(msg.text, msg.lang, this.state.lang);
                    this.renderMessageBubble(text, msg.text, msg.senderName);
                    if(this.state.isTTSActive) this.queueAudio(text);
                });
            }

            renderMessageBubble(text, original, sender) {
                const stream = document.getElementById('student-stream');
                const bubble = document.createElement('div');
                bubble.className = "message-bubble bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 mb-4 animate-slide-up max-w-[90%]";
                bubble.innerHTML = `
                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">${sender}</p>
                    <p class="text-lg font-medium text-gray-800 leading-snug">${text}</p>
                    <div class="border-t border-gray-100 mt-2 pt-1"><p class="text-xs text-gray-400 italic truncate">${original}</p></div>
                `;
                stream.appendChild(bubble);
                stream.scrollTop = stream.scrollHeight;
            }

            sendRaiseHandRequest() {
                this.student.chatRequestPending = true;
                this.updateChatControls();
                push(ref(this.db, `chats/${this.state.room}/handRaises`), {
                    senderName: this.state.name, lang: this.state.lang, timestamp: Date.now()
                });
                this.showToast("Hand Raised", "success");
            }

            openChatModal() { this.toggleModal('chat'); }
            
            sendStudentChat() {
                const val = document.getElementById('chat-input').value.trim();
                if(!val) return;
                push(ref(this.db, `chats/${this.state.room}/studentChats`), {
                    senderName: this.state.name, lang: this.state.lang, text: val, timestamp: Date.now()
                });
                document.getElementById('chat-input').value = '';
                this.toggleModal('chat');
            }

            sendQuestion() {
                const val = document.getElementById('q-input').value.trim();
                if(!val) return;
                push(ref(this.db, `chats/${this.state.room}/questions`), {
                    senderName: this.state.name, lang: this.state.lang, text: val, timestamp: Date.now()
                });
                document.getElementById('q-input').value = '';
                this.toggleModal('question');
            }

            // --- SHARED UTILS ---

            async translateText(text, source, target) {
                if (!text) return "";
                if (!source || !target) return text;
                
                // Fix: Google Translate API (free tier) fails with full locale codes (e.g. en-US). 
                const s = source.startsWith('zh') ? source : source.split('-')[0];
                const t = target.startsWith('zh') ? target : target.split('-')[0];
                if (s === t) return text;

                try {
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${s}&tl=${t}&dt=t&q=${encodeURIComponent(text)}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    if (json && json[0]) return json[0].map(x => x[0]).join("");
                    return text;
                } catch (e) {
                    console.error("Translation failed", e);
                    return text;
                }
            }

            queueAudio(text) {
                // Simplified TTS for brevity - restores Cartesia logic from original if needed
                if(!window.speechSynthesis) return;
                const u = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(u);
            }

            toggleTTS() {
                this.state.isTTSActive = !this.state.isTTSActive;
                this.showToast(this.state.isTTSActive ? "Voice Enabled" : "Voice Muted");
            }

            switchTeacherTab(tab) {
                if(tab === 'questions') {
                    document.getElementById('tab-questions-content').classList.remove('hidden');
                    document.getElementById('tab-students-content').classList.add('hidden');
                } else {
                    document.getElementById('tab-questions-content').classList.add('hidden');
                    document.getElementById('tab-students-content').classList.remove('hidden');
                }
            }

            sendReaction(emoji) {
                push(ref(this.db, `chats/${this.state.room}/reactions`), { emoji, senderName: this.state.name });
                this.showToast(`Sent ${emoji}`);
            }

            copyCode() {
                navigator.clipboard.writeText(this.state.room);
                this.showToast("Copied!", "success");
            }
            
            clearNotifications() {
                document.getElementById('notifications-list').innerHTML = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => new SuccesApp());
    </script>
</body>
</html>