<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#3b82f6" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/png" href="./pwa_icon.png" />
  <link rel="apple-touch-icon" href="./pwa_icon.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Succes Class - Real-time Translation & Hybrid Learning</title>

  <!-- Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "sans-serif"],
            mono: ["JetBrains Mono", "monospace"],
          },
          colors: {
            brand: {
              50: "#f0f9ff",
              100: "#e0f2fe",
              500: "#0ea5e9",
              600: "#0284c7",
              900: "#0c4a6e",
            },
            accent: {
              500: "#8b5cf6",
            },
          },
          animation: {
            "fade-in": "fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards",
            "slide-up": "slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards",
            "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
          },
          keyframes: {
            fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
            slideUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } },
          },
        },
      },
    };
  </script>

  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.5);
      --glass-blur: blur(12px);
      --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
      --shadow-hard: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
    }

    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f3f4f6 0%, #e0f2fe 100%);
      height: 100vh;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      color: #1f2937;
    }

    .input-glass {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .input-glass:focus {
      background: #ffffff;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.01);
      outline: none;
    }

    .btn-modern {
      transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .btn-modern:active {
      transform: scale(0.97);
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-soft);
    }

    .message-bubble {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: transform 0.2s;
      transform-origin: bottom left;
    }

    .mic-active-ring {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .mic-active-ring-green {
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      animation: pulse-ring-green 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    @keyframes pulse-ring-green {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    .view-transition {
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .view-hidden {
      opacity: 0;
      pointer-events: none;
      position: absolute;
      inset: 0;
      transform: scale(0.98);
      z-index: -1;
    }

    .view-active {
      opacity: 1;
      pointer-events: auto;
      position: relative;
      transform: scale(1);
      z-index: 10;
    }
  </style>
</head>

<body class="antialiased text-gray-800">
  <!-- Toast Container -->
  <div id="toast-container"
    class="fixed top-4 left-0 right-0 z-50 pointer-events-none flex flex-col items-center gap-2 p-4"></div>

  <main id="app"
    class="relative w-full h-full max-w-lg mx-auto bg-white/50 shadow-2xl overflow-hidden md:max-w-none md:w-full md:h-full md:my-0 md:rounded-none md:border-0 backdrop-blur-3xl">

    <!-- VIEW: TEACHER LOBBY -->
    <section id="view-lobby" class="view-hidden w-full h-full flex flex-col bg-white text-center p-8">
      <div class="flex-1 flex flex-col items-center justify-center space-y-8 animate-slide-up">
        <h2 class="text-2xl font-bold text-gray-900">Classroom Ready</h2>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 relative">
          <div class="absolute inset-0 bg-blue-500/5 rounded-3xl blur-xl -z-10"></div>
          <div
            class="w-48 h-48 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 text-6xl shadow-inner mb-4 border border-blue-100">
            <i class="fa-solid fa-qrcode"></i>
          </div>
          <div class="space-y-1">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Room Code</p>
            <p id="lobby-code" class="text-4xl font-mono font-black text-blue-600 tracking-widest">----</p>
          </div>
        </div>

        <p class="text-gray-500 max-w-xs mx-auto text-sm">
          Share this code with students to let them join the conversation.
        </p>
      </div>

      <button onclick="App.startSession()"
        class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 flex items-center justify-center gap-3 animate-slide-up">
        <span>Start Session</span>
        <i class="fa-solid fa-play"></i>
      </button>
    </section>

    <!-- VIEW: STUDENT -->
    <section id="view-student" class="view-hidden w-full h-full flex flex-col bg-white">
      <header
        class="h-16 px-6 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <button onclick="App.logout()" title="Logout"
            class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-gray-900 transition-colors">
            <i class="fa-solid fa-arrow-left text-sm"></i>
          </button>
          <div>
            <h2 id="student-name-display"
              class="font-bold text-gray-900 leading-tight text-sm text-truncate max-w-[120px]">Student</h2>
            <div class="flex items-center gap-1">
              <span class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Receiving:</span>
              <span id="student-lang-badge" class="text-[10px] font-black uppercase text-blue-600">EN</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="student-history.html" title="View My History"
            class="text-gray-400 hover:text-blue-500 transition-colors">
            <i class="fa-solid fa-clock-rotate-left"></i>
          </a>
          <button id="tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
            class="text-gray-400 hover:text-blue-500 transition-colors">
            <i id="tts-icon" class="fa-solid fa-volume-xmark"></i>
          </button>
          <span class="relative flex h-3 w-3">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
          </span>
        </div>
      </header>

      <div id="student-stream"
        class="flex-1 overflow-y-auto p-6 space-y-6 pb-32 bg-gray-50/50 custom-scrollbar scroll-smooth">
        <div class="text-center py-10 opacity-60">
          <div
            class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-xl">
            <i class="fa-solid fa-ear-listen"></i>
          </div>
          <p class="text-sm font-medium text-gray-500">
            Connected to <span class="font-mono text-gray-700 font-bold" id="student-room-code">...</span>
          </p>
          <p class="text-xs text-gray-400 mt-1">Listening for speech...</p>
        </div>
      </div>

      <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent z-20">
        <div class="flex items-center justify-between gap-4">
          <div class="flex gap-3">
            <button onclick="App.sendReaction('üëç')"
              class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">üëç</button>
            <button onclick="App.sendReaction('‚ù§Ô∏è')"
              class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">‚ù§Ô∏è</button>
            <button id="raise-hand-btn" onclick="App.sendRaiseHandRequest()" title="Raise Hand"
              class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50 hover:scale-110">
              <i class="fa-solid fa-hand"></i>
            </button>
            <button id="chat-btn-student" onclick="App.openChatModal()" title="Chat"
              class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50 hover:scale-110">
              <i class="fa-solid fa-comment-dots"></i>
            </button>
          </div>

          <button id="mic-btn-student" onclick="App.handleStudentMicAction()"
            class="btn-modern h-12 px-6 rounded-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold shadow-lg shadow-blue-500/20 flex items-center gap-2">
            <i id="mic-icon-student" class="fa-solid fa-microphone-lines"></i>
            <span id="mic-label-student">Request Mic</span>
          </button>
        </div>
      </div>
    </section>

    <!-- VIEW: TEACHER -->
    <section id="view-teacher" class="view-hidden w-full h-full flex flex-col bg-slate-50">
      <header class="h-16 px-6 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-30">
        <div class="flex items-center gap-3">
          <button onclick="App.logout()" title="Logout" class="text-gray-400 hover:text-red-500 transition-colors">
            <i class="fa-solid fa-power-off"></i>
          </button>
          <div class="h-6 w-px bg-gray-200 mx-1"></div>
          <div>
            <h1 class="font-bold text-gray-900 text-sm">Teacher Panel</h1>
            <div class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-100 px-1.5 rounded transition-colors"
              onclick="App.copyCode()">
              <p class="text-xs text-gray-500 font-mono tracking-wider " id="teacher-code-display">CODE</p>
              <i class="fa-regular fa-copy text-[10px] text-gray-400"></i>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="teacher-agent.html" title="AI Assistant" class="text-gray-400 hover:text-purple-500 transition-colors">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
          </a>
          <a href="history.html" title="View History" class="text-gray-400 hover:text-blue-500 transition-colors">
            <i class="fa-solid fa-clock-rotate-left"></i>
          </a>
          <button id="teacher-tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
            class="text-gray-400 hover:text-blue-500 transition-colors">
            <i id="teacher-tts-icon" class="fa-solid fa-volume-xmark"></i>
          </button>
          <button id="mic-btn" onclick="App.toggleMic()" title="Toggle Microphone"
            class="btn-modern relative w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition-all hover:bg-gray-200">
            <i class="fa-solid fa-microphone-slash text-sm"></i>
          </button>
          <button id="notif-btn" onclick="App.toggleModal('notifications')" title="Notifications"
            class="relative text-gray-400 hover:text-blue-500 transition-colors">
            <i class="fa-solid fa-bell text-lg"></i>
            <span id="notif-badge"
              class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center">0</span>
          </button>
        </div>
      </header>

      <main class="flex-1 p-4 grid grid-rows-2 gap-4 h-[calc(100%-4rem)]">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative group">
          <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
              <i class="fa-solid fa-wave-square text-blue-500"></i> Live Audio
            </h3>
            <div id="mic-status" class="flex gap-1">
              <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse"></div>
              <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.1s"></div>
              <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
            </div>
          </div>

          <div id="teacher-transcript"
            class="flex-1 p-5 overflow-y-auto text-xl font-medium text-gray-400 italic leading-relaxed custom-scrollbar">
            Tap the microphone to start broadcasting...
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
          <div class="px-4 py-2 bg-gray-50/50 border-b border-gray-100 flex items-center gap-4">
            <button id="tab-questions-btn" onclick="App.switchTeacherTab('questions')"
              class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-blue-100 text-blue-700 transition-colors">
              <i class="fa-regular fa-comments"></i>
              Questions
              <span id="question-count"
                class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button id="tab-students-btn" onclick="App.switchTeacherTab('students')"
              class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-500 hover:bg-gray-100 transition-colors">
              <i class="fa-solid fa-users"></i>
              Students
              <span id="student-count"
                class="bg-gray-300 text-gray-700 text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
          </div>

          <div id="tab-questions-content" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 custom-scrollbar">
            <div id="teacher-questions"></div>
            <div id="teacher-empty" class="text-center py-8 opacity-40">
              <i class="fa-regular fa-comments text-2xl mb-2 text-gray-400"></i>
              <p class="text-xs text-gray-500">No questions yet</p>
            </div>
          </div>

          <div id="tab-students-content"
            class="hidden flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 custom-scrollbar">
            <div id="students-list"></div>
            <div id="students-empty" class="text-center py-8 opacity-40">
              <i class="fa-solid fa-users text-2xl mb-2 text-gray-400"></i>
              <p class="text-xs text-gray-500">No students connected yet</p>
            </div>
          </div>
        </div>
      </main>
    </section>

    <!-- MODAL: QUESTION -->
    <div id="modal-question" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"
        onclick="App.toggleModal('question')"></div>
      <div
        class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
        id="modal-panel">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-1">Ask a Question</h3>
          <p class="text-sm text-gray-500 mb-6">Your question will be translated for the teacher.</p>

          <div class="relative mb-6">
            <input id="q-input" type="text"
              class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 transition-colors"
              placeholder="Type your question..." onkeydown="if(event.key === 'Enter') App.sendQuestion()" />
          </div>

          <div class="flex gap-3">
            <button onclick="App.toggleModal('question')"
              class="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
            <button onclick="App.sendQuestion()"
              class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-colors">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: CHAT -->
    <div id="modal-chat" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0" id="chat-backdrop"
        onclick="App.toggleModal('chat')"></div>
      <div
        class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
        id="chat-panel">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-1">Send a Chat</h3>
          <p class="text-sm text-gray-500 mb-6">Your message will be translated for the teacher.</p>

          <div class="relative mb-6">
            <input id="chat-input" type="text"
              class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 transition-colors"
              placeholder="Type your message..." onkeydown="if(event.key === 'Enter') App.sendStudentChat()" />
          </div>

          <div class="flex gap-3">
            <button onclick="App.toggleModal('chat')"
              class="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
            <button onclick="App.sendStudentChat()"
              class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-colors">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: NOTIFICATIONS -->
    <div id="modal-notifications" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
        id="notifications-backdrop" onclick="App.toggleModal('notifications')"></div>
      <div
        class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
        id="notifications-panel">
        <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl flex flex-col max-h-[60vh]">
          <div
            class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-3xl">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-bell text-blue-500"></i>
              <h3 class="text-lg font-bold text-gray-900">Notifications</h3>
            </div>
            <button onclick="App.clearNotifications()"
              class="text-xs text-gray-400 hover:text-red-500 font-semibold">Clear All</button>
          </div>

          <div id="notifications-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
            <div id="notifications-empty" class="text-center py-10 opacity-40">
              <i class="fa-regular fa-bell-slash text-2xl mb-2 text-gray-400"></i>
              <p class="text-xs text-gray-500">No notifications yet</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script type="module">
    // ==== CRASH OVERLAY (NO MORE SILENT WHITE SCREEN) ====
    const crash = (title, err) => {
      const msg = (err?.stack || err?.message || String(err || "Unknown error"));
      document.body.innerHTML = `
        <div style="font-family:ui-monospace,SFMono-Regular,Menlo,monospace;padding:16px;">
          <h2 style="font-size:18px;font-weight:800;color:#b91c1c;">${title}</h2>
          <pre style="white-space:pre-wrap;background:#111827;color:#e5e7eb;padding:12px;border-radius:10px;margin-top:12px;">${msg.replace(/</g, "&lt;")}</pre>
        </div>
      `;
    };
    window.addEventListener("error", (e) => crash("App Crash (JS Error)", e?.error || e));
    window.addEventListener("unhandledrejection", (e) => crash("App Crash (Promise Rejection)", e?.reason || e));

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    // ==== SIMPLE RMS VAD (works everywhere) ====
    class SimpleVAD {
      constructor(stream, opts = {}) {
        this.stream = stream;
        this.opts = {
          intervalMs: 50,
          minSpeechMs: 120,
          minSilenceMs: 800,
          userThreshold: 0.018,
          noiseAdapt: 0.08,
          hangoverMs: 150,
          onSpeechStart: () => { },
          onSpeechEnd: () => { },
          onLevel: () => { },
          ...opts,
        };

        this._ctx = null;
        this._src = null;
        this._an = null;
        this._buf = null;
        this._timer = null;

        this._isSpeech = false;
        this._speechMs = 0;
        this._silenceMs = 0;
        this._hangMs = 0;

        this._noiseFloor = 0.012;
        this._lastTs = 0;
      }

      async start() {
        if (!this.stream) return;
        this._ctx = new (window.AudioContext || window.webkitAudioContext)();
        this._src = this._ctx.createMediaStreamSource(this.stream);
        this._an = this._ctx.createAnalyser();
        this._an.fftSize = 1024;
        this._buf = new Float32Array(this._an.fftSize);
        this._src.connect(this._an);

        this._lastTs = performance.now();
        this._timer = setInterval(() => this._tick(), this.opts.intervalMs);
      }

      _tick() {
        if (!this._an) return;
        const now = performance.now();
        const dt = Math.max(1, now - this._lastTs);
        this._lastTs = now;

        this._an.getFloatTimeDomainData(this._buf);
        let sum = 0;
        for (let i = 0; i < this._buf.length; i++) sum += this._buf[i] * this._buf[i];
        const rms = Math.sqrt(sum / this._buf.length);

        const quiet = rms < this._noiseFloor * 1.25;
        if (!this._isSpeech || quiet) {
          const a = this.opts.noiseAdapt;
          this._noiseFloor = (1 - a) * this._noiseFloor + a * rms;
          this._noiseFloor = Math.min(Math.max(this._noiseFloor, 0.004), 0.08);
        }

        const dynamicThreshold = Math.max(this.opts.userThreshold, this._noiseFloor * 3.2);
        const isLoud = rms >= dynamicThreshold;

        this.opts.onLevel(Math.min(1, rms * 18), rms, dynamicThreshold, this._noiseFloor);

        if (this._isSpeech) {
          if (isLoud) {
            this._silenceMs = 0;
            this._hangMs = this.opts.hangoverMs;
          } else {
            if (this._hangMs > 0) this._hangMs -= dt;
            else this._silenceMs += dt;
          }
          if (this._silenceMs >= this.opts.minSilenceMs) {
            this._isSpeech = false;
            this._speechMs = 0;
            this._silenceMs = 0;
            this._hangMs = 0;
            this.opts.onSpeechEnd();
          }
        } else {
          if (isLoud) this._speechMs += dt;
          else this._speechMs = 0;

          if (this._speechMs >= this.opts.minSpeechMs) {
            this._isSpeech = true;
            this._silenceMs = 0;
            this._hangMs = this.opts.hangoverMs;
            this.opts.onSpeechStart();
          }
        }
      }

      async stop() {
        if (this._timer) clearInterval(this._timer);
        this._timer = null;
        try { if (this._src) this._src.disconnect(); } catch (_) { }
        this._src = null;
        this._an = null;
        this._buf = null;
        try { if (this._ctx) await this._ctx.close(); } catch (_) { }
        this._ctx = null;
      }
    }

    // --- CREDENTIALS ---
    const CREDENTIALS = {
      CARTESIA: "sk_car_yWEX9Mp2LwKju8FXyosGhj",
      CARTESIA_VOICES: {
        "en": "cbaf8084-f009-4838-a096-07ee2e6612b1",
        "hi": "faf0731e-dfb9-4cfc-8119-259a79b27e12",
        "es": "5c5ad5e7-1020-476b-8b91-fdcbe9cc313c",
        "de": "38aabb6a-f52b-4fb0-a3d1-988518f4dc06",
        "ar": "002622d8-19d0-4567-a16a-f99c7397c062",
        "fr": "a8a1eb38-5f15-4c1d-8722-7ac0f329727d",
        "ko": "304fdbd8-65e6-40d6-ab78-f9d18b9efdf9",
        "ja": "2b568345-1d48-4047-b25f-7baccf842eb0",
        "pt": "700d1ee3-a641-4018-ba6e-899dcadc9e2b",
        "ta": "25d2c432-139c-4035-bfd6-9baaabcdd006",
        "te": "07bc462a-c644-49f1-baf7-82d5599131be",
        "nl": "9e8db62d-056f-47f3-b3b6-1b05767f9176",
        "nl-BE": "9e8db62d-056f-47f3-b3b6-1b05767f9176",
        "default": "cbaf8084-f009-4838-a096-07ee2e6612b1"
      },
      CARTESIA_PDICT: {
        "nl-BE": "pdict_TPgLmfbAo9pQoorcetVez8"
      },
      FIREBASE: {
        apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
        authDomain: "macx-5feca.firebaseapp.com",
        databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "macx-5feca",
        storageBucket: "macx-5feca.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdef1234567890abcdef"
      }
    };

    // Minimal language meta used by THIS file only (no more giant list = no parse risks).
    // Your selection UI is in auth.html anyway; here we only need name/flag for teacher list.
    const LANGUAGES = [
      { code: 'en', name: 'English', flag: 'üá∫üá∏' },
      { code: 'nl', name: 'Dutch', flag: 'üá≥üá±' },
      { code: 'nl-BE', name: 'Flemish', flag: 'üáßüá™' },
      { code: 'fil', name: 'Filipino', flag: 'üáµüá≠' },
      { code: 'es', name: 'Spanish', flag: 'üá™üá∏' },
      { code: 'fr', name: 'French', flag: 'üá´üá∑' },
      { code: 'de', name: 'German', flag: 'üá©üá™' }
    ];

    const CARTESIA_LANG_MAP = { fil: 'tl', tl: 'tl' };

    class SuccesApp {
      constructor() {
        this.app = initializeApp(CREDENTIALS.FIREBASE);
        this.db = getDatabase(this.app);

        this.state = {
          role: null,
          room: '',
          name: '',
          gender: 'Male',
          lang: 'en',
          isMicActive: false,
          isTTSActive: false,
          audioQueue: [],
          isAudioPlaying: false
        };

        this.recognition = null;
        this.wakeLock = null;

        // Teacher VAD + buffers
        this.teacherStream = null;
        this.teacherVAD = null;
        this.teacherBuffer = '';
        this.teacherInterim = '';

        // Student flow
        this.student = {
          requestPending: false,
          approved: false,
          recording: false,
          approvalKey: null,
          chatRequestPending: false,
          chatApproved: false,

          recognition: null,
          mediaRecorder: null,
          mediaStream: null,
          audioChunks: [],
          finalParts: [],
          lastInterim: '',

          vad: null,
          autoStopArmed: false,
          stopping: false
        };

        this.bindAll();
        this.init();
      }

      bindAll() {
        [
          'startSession', 'logout', 'toggleMic', 'sendQuestion', 'toggleModal',
          'sendReaction', 'toggleTTS', 'handleStudentMicAction', 'approveMicRequest',
          'sendRaiseHandRequest', 'openChatModal', 'sendStudentChat', 'approveChatRequest',
          'switchTeacherTab', 'clearNotifications'
        ].forEach(m => this[m] = this[m].bind(this));
      }

      saveState() {
        localStorage.setItem('orbit_session', JSON.stringify({
          role: this.state.role,
          room: this.state.room,
          name: this.state.name,
          lang: this.state.lang,
          currentView: this.state.currentView
        }));
      }

      clearState() { localStorage.removeItem('orbit_session'); }

      init() {
        window.App = this;

        const saved = localStorage.getItem('orbit_session');
        if (!saved) { window.location.href = 'auth.html'; return; }

        try {
          const data = JSON.parse(saved);
          if (!data.role || !data.room) { window.location.href = 'auth.html'; return; }
          this.state = { ...this.state, ...data };

          if (this.state.role === 'student') {
            this.initStudent();
            this.switchView(this.state.currentView || 'view-student');
          } else if (this.state.role === 'teacher') {
            if (this.state.currentView === 'view-teacher') {
              this.initTeacher();
              this.switchView('view-teacher');
            } else {
              document.getElementById('lobby-code').innerText = this.state.room;
              this.switchView('view-lobby');
            }
          }
        } catch (e) {
          this.clearState();
          window.location.href = 'auth.html';
          return;
        }

        this.registerServiceWorker();
      }

      switchView(viewId) {
        this.state.currentView = viewId;
        this.saveState();

        document.querySelectorAll('section').forEach(el => {
          el.classList.remove('view-active');
          el.classList.add('view-hidden');
        });

        const target = document.getElementById(viewId);
        setTimeout(() => {
          target.classList.remove('view-hidden');
          target.classList.add('view-active');
        }, 50);
      }

      registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW failed:', err));
        }
      }

      showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const colors = { info: 'bg-gray-800 text-white', success: 'bg-green-600 text-white', error: 'bg-red-500 text-white' };
        toast.className = `${colors[type]} px-4 py-2 rounded-lg shadow-xl text-sm font-semibold transform transition-all duration-300 translate-y-[-20px] opacity-0 flex items-center gap-2`;
        toast.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : msg;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
        setTimeout(() => {
          toast.classList.add('opacity-0', 'translate-y-[-10px]');
          setTimeout(() => toast.remove(), 300);
        }, 2800);
      }

      toggleModal(type) {
        const modal = document.getElementById(`modal-${type}`);
        const bdId = type === 'chat' ? 'chat-backdrop' : (type === 'notifications' ? 'notifications-backdrop' : 'modal-backdrop');
        const panelId = type === 'chat' ? 'chat-panel' : (type === 'notifications' ? 'notifications-panel' : 'modal-panel');
        const bd = document.getElementById(bdId);
        const panel = document.getElementById(panelId);

        if (!modal || !bd || !panel) return;

        if (modal.classList.contains('hidden')) {
          modal.classList.remove('hidden');
          setTimeout(() => {
            bd.style.opacity = '1';
            panel.style.transform = (window.innerWidth < 768) ? 'translateY(0)' : 'translate(-50%, -50%)';
          }, 10);
        } else {
          bd.style.opacity = '0';
          panel.style.transform = (window.innerWidth < 768) ? 'translateY(100%)' : 'translate(-50%, 0)';
          setTimeout(() => modal.classList.add('hidden'), 300);
        }
      }

      startSession() {
        this.initTeacher();
        this.switchView('view-teacher');
      }

      async logout() {
        if (this.state.isMicActive) await this.toggleMic();
        if (this.student.recording || this.student.approved) await this.stopStudentCapture(false);

        this.clearState();
        window.location.href = 'auth.html';
      }

      // ===== Sentence segmentation =====
      cleanOkeyPeriods(text) {
        if (!text) return text;
        return text
          .replace(/^(ok[e√©y]*)\.\s*/gi, '$1 ')
          .replace(/\s(ok[e√©y]*)\.\s*/gi, ' $1 ')
          .replace(/^(ok[e√©y]*)\.$/gi, '$1')
          .trim();
      }

      extractSentences(bufferText) {
        let buf = (bufferText || '').replace(/\s+/g, ' ').trimStart();
        const sentences = [];
        const endRe = /^([\s\S]*?[.!?„ÄÇÔºÅÔºü]+)(\s+|$)/;
        while (true) {
          const m = buf.match(endRe);
          if (!m) break;
          const s = (m[1] || '').trim();
          if (s) sentences.push(s);
          buf = buf.slice((m[0] || '').length);
        }
        return { sentences, remainder: buf.trimStart() };
      }

      flushAsSentence(text) {
        const t = (text || '').replace(/\s+/g, ' ').trim();
        return t ? [t] : [];
      }

      // ===== Emotion selection =====
      pickEmotion(text) {
        const t = (text || '').toLowerCase();
        if (/\b(hate|stupid|idiot|shut up|stop it|how dare|angry|furious|mad)\b/.test(t)) return 'angry';
        if (/\b(danger|warning|careful|risk|afraid|scared|panic|emergency)\b/.test(t)) return 'scared';
        if (/\b(sorry|sad|unfortunately|regret|miss|lost|hurt|apologize|disappointed)\b/.test(t)) return 'sad';
        if (/[!]/.test(t) || /\b(awesome|amazing|great|wow|congrats|excellent|fantastic)\b/.test(t)) return 'excited';
        if (/\?/.test(t)) return 'curious';
        if (/\b(thanks|thank you|good|okay|alright|nice)\b/.test(t)) return 'content';
        return 'neutral';
      }

      cartesiaBaseLang(langCode) {
        const lc = (langCode || 'en').trim();
        const base = lc.split('-')[0];
        return CARTESIA_LANG_MAP[lc] || CARTESIA_LANG_MAP[base] || base;
      }

      // ===== TTS =====
      toggleTTS() {
        this.state.isTTSActive = !this.state.isTTSActive;

        const sIcon = document.getElementById('tts-icon');
        const sBtn = document.getElementById('tts-btn');
        const tIcon = document.getElementById('teacher-tts-icon');
        const tBtn = document.getElementById('teacher-tts-btn');

        const updateUI = (icon, btn) => {
          if (!icon || !btn) return;
          if (this.state.isTTSActive) {
            icon.className = "fa-solid fa-volume-high";
            btn.classList.add('text-blue-500');
          } else {
            icon.className = "fa-solid fa-volume-xmark";
            btn.classList.remove('text-blue-500');
          }
        };

        updateUI(sIcon, sBtn);
        updateUI(tIcon, tBtn);

        if (this.state.isTTSActive) {
          this.processAudioQueue();
          this.showToast("Voice Output Enabled", "success");
        } else {
          this.showToast("Voice Output Muted", "info");
        }
      }

      queueAudio(text, gender) {
        const cleaned = this.cleanOkeyPeriods((text || '').trim());
        const seg = this.extractSentences(cleaned);
        const parts = [...seg.sentences, ...this.flushAsSentence(seg.remainder)];
        for (const p of parts) {
          const s = (p || '').trim();
          if (!s) continue;
          this.state.audioQueue.push({ text: s, gender });
        }
        if (this.state.isTTSActive) this.processAudioQueue();
      }

      async processAudioQueue() {
        if (this.state.isAudioPlaying || this.state.audioQueue.length === 0) return;
        this.state.isAudioPlaying = true;

        const item = this.state.audioQueue.shift();
        try {
          const lang = this.state.lang;
          const baseLang = this.cartesiaBaseLang(lang);
          const voiceId = CREDENTIALS.CARTESIA_VOICES[lang] ||
            CREDENTIALS.CARTESIA_VOICES[lang.split('-')[0]] ||
            CREDENTIALS.CARTESIA_VOICES["default"];

          const emotion = this.pickEmotion(item.text);

          const transcript = `<emotion value="${emotion}" /> ${item.text}`;

          const res = await fetch("https://api.cartesia.ai/tts/bytes", {
            method: "POST",
            headers: {
              "Cartesia-Version": "2025-04-16",
              "X-API-Key": CREDENTIALS.CARTESIA,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model_id: "sonic-3-latest",
              transcript,
              voice: { mode: "id", id: voiceId },
              output_format: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 },
              language: baseLang,
              ...(CREDENTIALS.CARTESIA_PDICT[lang] ? { pronunciation_dict_id: CREDENTIALS.CARTESIA_PDICT[lang] } : {}),
              generation_config: { speed: 1.1, volume: 1.0, emotion } // emotion MUST be string
            })
          });

          if (!res.ok) throw new Error(`Cartesia ${res.status}`);

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.onended = () => {
            URL.revokeObjectURL(url);
            this.state.isAudioPlaying = false;
            this.processAudioQueue();
          };
          await audio.play();
        } catch (e) {
          console.error("TTS Error", e);
          this.state.isAudioPlaying = false;
          this.processAudioQueue();
        }
      }

      // ===== Student =====
      updateStudentMicButton() {
        const btn = document.getElementById('mic-btn-student');
        const icon = document.getElementById('mic-icon-student');
        const label = document.getElementById('mic-label-student');
        if (!btn || !icon || !label) return;

        btn.disabled = false;
        btn.classList.remove(
          'bg-[#0ea5e9]', 'hover:bg-[#0284c7]',
          'bg-amber-500', 'hover:bg-amber-600',
          'bg-green-500', 'hover:bg-green-600',
          'mic-active-ring-green',
          'opacity-70', 'cursor-not-allowed'
        );

        if (this.state.role !== 'student') {
          icon.className = "fa-solid fa-microphone-lines";
          label.textContent = "Request Mic";
          return;
        }

        if (this.student.recording) {
          btn.classList.add('bg-green-500', 'hover:bg-green-600', 'mic-active-ring-green');
          icon.className = "fa-solid fa-microphone";
          label.textContent = "Stop & Send";
          return;
        }

        if (this.student.approved) {
          btn.classList.add('bg-green-500', 'hover:bg-green-600', 'mic-active-ring-green');
          icon.className = "fa-solid fa-microphone";
          label.textContent = "Speaking...";
          return;
        }

        if (this.student.requestPending) {
          btn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'opacity-70', 'cursor-not-allowed');
          btn.disabled = true;
          icon.className = "fa-solid fa-hourglass-half";
          label.textContent = "Requested";
          return;
        }

        btn.classList.add('bg-[#0ea5e9]', 'hover:bg-[#0284c7]');
        icon.className = "fa-solid fa-microphone-lines";
        label.textContent = "Request Mic";
      }

      updateChatControls() {
        const raiseBtn = document.getElementById('raise-hand-btn');
        const chatBtn = document.getElementById('chat-btn-student');
        if (!raiseBtn || !chatBtn) return;

        raiseBtn.disabled = false;
        chatBtn.disabled = false;
        raiseBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600', 'opacity-70', 'cursor-not-allowed');
        chatBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'opacity-60', 'cursor-not-allowed');

        if (this.state.role !== 'student') {
          chatBtn.disabled = true;
          chatBtn.classList.add('opacity-60', 'cursor-not-allowed');
          return;
        }

        if (this.student.chatApproved) {
          chatBtn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
        } else {
          chatBtn.disabled = true;
          chatBtn.classList.add('opacity-60', 'cursor-not-allowed');
        }

        if (this.student.chatRequestPending) {
          raiseBtn.disabled = true;
          raiseBtn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'opacity-70', 'cursor-not-allowed');
        }
      }

      async handleStudentMicAction() {
        if (this.state.role !== 'student' || !this.state.room) return;

        if (this.student.recording) {
          await this.stopStudentCapture(true);
          return;
        }

        if (this.student.approved && !this.student.recording) {
          await this.startStudentCapture();
          return;
        }

        if (this.student.requestPending) return;
        await this.sendStudentMicRequest();
      }

      async sendStudentMicRequest() {
        try {
          this.student.requestPending = true;
          this.updateStudentMicButton();
          await push(ref(this.db, `chats/${this.state.room}/requests`), {
            senderName: this.state.name,
            senderId: this.state.name,
            lang: this.state.lang,
            timestamp: Date.now()
          });
          this.showToast("Microphone request sent", "success");
        } catch (e) {
          this.student.requestPending = false;
          this.updateStudentMicButton();
          this.showToast("Failed to send request: " + e.message, "error");
        }
      }

      async sendRaiseHandRequest() {
        if (this.state.role !== 'student' || !this.state.room) return;
        if (this.student.chatApproved) return this.showToast("Chat already approved", "info");
        if (this.student.chatRequestPending) return;

        try {
          this.student.chatRequestPending = true;
          this.updateChatControls();
          await push(ref(this.db, `chats/${this.state.room}/handRaises`), {
            senderName: this.state.name,
            senderId: this.state.name,
            lang: this.state.lang,
            timestamp: Date.now()
          });
          this.showToast("Hand raised", "success");
        } catch (e) {
          this.student.chatRequestPending = false;
          this.updateChatControls();
          this.showToast("Failed to raise hand: " + e.message, "error");
        }
      }

      listenForStudentApproval() {
        const aRef = ref(this.db, `chats/${this.state.room}/approvedSpeakers`);
        onChildAdded(aRef, async (snap) => {
          if (this.state.role !== 'student') return;
          const a = snap.val();
          if (!a) return;
          const speaker = a.speakerName || a.name || '';
          if (speaker && speaker === this.state.name) {
            this.student.approved = true;
            this.student.requestPending = false;
            this.student.approvalKey = snap.key;
            this.updateStudentMicButton();
            this.showToast("Approved! Mic opened.", "success");
            try { await remove(ref(this.db, `chats/${this.state.room}/approvedSpeakers/${snap.key}`)); } catch (_) { }
            await this.startStudentCapture();
          }
        });
      }

      listenForChatApproval() {
        const aRef = ref(this.db, `chats/${this.state.room}/approvedChat`);
        onChildAdded(aRef, async (snap) => {
          if (this.state.role !== 'student') return;
          const a = snap.val();
          if (!a) return;
          const speaker = a.speakerName || a.name || '';
          if (speaker && speaker === this.state.name) {
            this.student.chatApproved = true;
            this.student.chatRequestPending = false;
            this.updateChatControls();
            this.showToast("Chat approved", "success");
            try { await remove(ref(this.db, `chats/${this.state.room}/approvedChat/${snap.key}`)); } catch (_) { }
          }
        });
      }

      openChatModal() {
        if (this.state.role !== 'student') return;
        if (!this.student.chatApproved) return this.showToast("Raise your hand to chat", "info");
        this.toggleModal('chat');
      }

      async sendStudentChat() {
        const val = document.getElementById('chat-input')?.value?.trim();
        if (!val) return;
        if (!this.student.chatApproved) return this.showToast("Chat not approved yet", "error");

        try {
          let teacherLang = null;
          try {
            const metaSnap = await get(ref(this.db, `chats/${this.state.room}/meta`));
            if (metaSnap.exists()) teacherLang = metaSnap.val()?.teacherLang || null;
          } catch (_) { }

          let textForTeacher = null;
          if (teacherLang) textForTeacher = await this.translateText(val, this.state.lang, teacherLang);

          await push(ref(this.db, `chats/${this.state.room}/studentChats`), {
            senderName: this.state.name,
            senderId: this.state.name,
            lang: this.state.lang,
            text: val,
            teacherLang: teacherLang || null,
            textForTeacher: textForTeacher || null,
            timestamp: Date.now()
          });

          document.getElementById('chat-input').value = '';
          this.toggleModal('chat');
          this.showToast("Chat sent", "success");
        } catch (e) {
          this.showToast("Failed to send chat: " + e.message, "error");
        }
      }

      async startStudentCapture() {
        if (this.student.recording) return;
        if (!SpeechRecognition) throw new Error("Web Speech API not supported");

        try {
          this.student.finalParts = [];
          this.student.lastInterim = '';
          this.student.stopping = false;

          this.student.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

          // VAD auto-stop on silence (hands-free)
          this.student.autoStopArmed = false;
          this.student.vad = new SimpleVAD(this.student.mediaStream, {
            minSilenceMs: 900,
            userThreshold: 0.018,
            onSpeechStart: () => { this.student.autoStopArmed = true; },
            onSpeechEnd: async () => {
              if (!this.student.recording) return;
              if (!this.student.autoStopArmed) return;
              if (this.student.stopping) return;

              const hasText = (this.student.finalParts.join(' ').trim() || this.student.lastInterim.trim());
              if (!hasText) return;

              this.student.stopping = true;
              await this.stopStudentCapture(true);
            }
          });
          await this.student.vad.start();

          // SpeechRecognition
          this.student.recognition = new SpeechRecognition();
          this.student.recognition.continuous = true;
          this.student.recognition.interimResults = true;
          this.student.recognition.lang = this.state.lang || 'en-US';
          this.student.recognition.maxAlternatives = 1;

          this.student.recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) finalTranscript += transcript;
              else interimTranscript += transcript;
            }
            this.student.lastInterim = interimTranscript;
            if (finalTranscript) this.student.finalParts.push(finalTranscript.trim());
          };

          this.student.recognition.onerror = (event) => console.error("Student STT error:", event.error);

          // MediaRecorder
          const options = {};
          try { options.mimeType = 'audio/webm'; } catch (_) { }
          this.student.mediaRecorder = new MediaRecorder(this.student.mediaStream, options);
          this.student.audioChunks = [];
          this.student.mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) this.student.audioChunks.push(e.data);
          };

          this.student.recognition.start();
          this.student.mediaRecorder.start(250);

          this.student.recording = true;
          this.updateStudentMicButton();
          this.showToast("Recording... (auto-stop on silence)", "info");
        } catch (e) {
          await this.stopStudentCapture(false);
          this.showToast("Student mic error: " + (e?.message || e), "error");
        }
      }

      async stopStudentCapture(submit = true) {
        try { if (this.student.recognition) this.student.recognition.stop(); } catch (_) { }

        const recorder = this.student.mediaRecorder;
        if (recorder && recorder.state !== 'inactive') {
          await new Promise((resolve) => {
            recorder.onstop = () => resolve();
            try { recorder.stop(); } catch (_) { resolve(); }
          });
        }

        try { if (this.student.vad) await this.student.vad.stop(); } catch (_) { }
        this.student.vad = null;

        try {
          if (this.student.mediaStream) this.student.mediaStream.getTracks().forEach(t => t.stop());
        } catch (_) { }

        let finalText = (this.student.finalParts.join(' ').trim() || this.student.lastInterim.trim() || '').trim();
        finalText = this.cleanOkeyPeriods(finalText);

        const chunks = this.student.audioChunks.slice();
        const mimeType = (this.student.mediaRecorder && this.student.mediaRecorder.mimeType) ? this.student.mediaRecorder.mimeType : 'audio/webm';

        this.student.recognition = null;
        this.student.mediaRecorder = null;
        this.student.mediaStream = null;
        this.student.audioChunks = [];
        this.student.finalParts = [];
        this.student.lastInterim = '';
        this.student.autoStopArmed = false;
        this.student.stopping = false;

        if (submit && finalText) {
          try {
            let teacherLang = null;
            try {
              const metaSnap = await get(ref(this.db, `chats/${this.state.room}/meta`));
              if (metaSnap.exists()) teacherLang = metaSnap.val()?.teacherLang || null;
            } catch (_) { }

            // segmentation cleanup
            const seg = this.extractSentences(finalText);
            finalText = [...seg.sentences, ...this.flushAsSentence(seg.remainder)].join(' ').trim() || finalText;

            let textForTeacher = null;
            if (teacherLang) textForTeacher = await this.translateText(finalText, this.state.lang, teacherLang);

            let audioBase64 = null;
            const blob = new Blob(chunks, { type: mimeType });
            if (blob.size <= 1_500_000) audioBase64 = await this.blobToBase64(blob);

            await push(ref(this.db, `chats/${this.state.room}/studentResponses`), {
              senderName: this.state.name,
              senderId: this.state.name,
              lang: this.state.lang,
              text: finalText,
              teacherLang: teacherLang || null,
              textForTeacher: textForTeacher || null,
              audioMimeType: mimeType,
              audioBase64: audioBase64 || null,
              timestamp: Date.now()
            });

            this.showToast(audioBase64 ? "Sent (audio + text)" : "Sent (text only)", "success");
          } catch (e) {
            this.showToast("Failed to submit: " + e.message, "error");
          }
        } else if (submit && !finalText) {
          this.showToast("No speech detected", "error");
        }

        this.student.recording = false;
        this.student.approved = false;
        this.student.requestPending = false;
        this.student.approvalKey = null;
        this.updateStudentMicButton();
      }

      async blobToBase64(blob) {
        return await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onerror = () => reject(r.error);
          r.onloadend = () => {
            const s = String(r.result || '');
            const idx = s.indexOf(',');
            resolve(idx >= 0 ? s.slice(idx + 1) : s);
          };
          r.readAsDataURL(blob);
        });
      }

      // ===== Student init =====
      initStudent() {
        document.getElementById('student-name-display').innerText = this.state.name;
        document.getElementById('student-room-code').innerText = this.state.room;
        document.getElementById('student-lang-badge').innerText = (this.state.lang || 'en').toUpperCase();

        this.updateStudentMicButton();
        this.updateChatControls();
        this.listenForStudentApproval();
        this.listenForChatApproval();
        this.registerStudent();

        const msgsRef = ref(this.db, `chats/${this.state.room}/messages`);
        onChildAdded(msgsRef, async (snap) => {
          if (this.state.role !== 'student') return;
          const msg = snap.val();
          if (!msg) return;

          const translated = await this.translateText(msg.text, msg.lang, this.state.lang);
          this.renderMessageBubble(translated, msg.text, msg.senderName);

          if (this.state.isTTSActive && msg.senderId !== this.state.name) {
            this.queueAudio(translated, msg.gender || 'Female');
          }
        });
      }

      async registerStudent() {
        if (this.state.role !== 'student' || !this.state.room) return;
        try {
          const langInfo = LANGUAGES.find(l => l.code === this.state.lang);
          const langName = langInfo ? langInfo.name : (this.state.lang || '').toUpperCase();
          await set(ref(this.db, `chats/${this.state.room}/students/${this.state.name}`), {
            name: this.state.name,
            lang: this.state.lang,
            langName,
            joinedAt: Date.now()
          });
        } catch (e) {
          console.error('Failed to register student:', e);
        }
      }

      renderMessageBubble(text, original, sender) {
        const stream = document.getElementById('student-stream');
        const bubble = document.createElement('div');
        bubble.className = "message-bubble bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 mb-4 animate-slide-up max-w-[90%]";
        bubble.innerHTML = `
          <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">${sender}</p>
          <p class="text-lg font-medium text-gray-800 leading-snug">${text}</p>
          <div class="border-t border-gray-100 mt-2 pt-1">
            <p class="text-xs text-gray-400 italic truncate">${original}</p>
          </div>
        `;
        stream.appendChild(bubble);
        stream.scrollTop = stream.scrollHeight;
      }

      // ===== Teacher init =====
      async initTeacher() {
        document.getElementById('teacher-code-display').innerText = this.state.room;

        try {
          await set(ref(this.db, `chats/${this.state.room}/meta`), {
            teacherLang: this.state.lang,
            teacherName: this.state.name,
            updatedAt: Date.now()
          });
        } catch (_) { }

        const qRef = ref(this.db, `chats/${this.state.room}/questions`);
        onChildAdded(qRef, async (snap) => {
          if (this.state.role !== 'teacher') return;
          const q = snap.val();
          if (!q) return;
          const trans = await this.translateText(q.text, q.lang, this.state.lang);
          this.renderQuestionCard({ kind: 'question', sender: q.senderName, text: trans, original: q.text });
          this.incrementQuestionCount();
          if (this.state.isTTSActive) this.queueAudio(trans, 'Female');
        });

        const rRef = ref(this.db, `chats/${this.state.room}/requests`);
        onChildAdded(rRef, async (snap) => {
          if (this.state.role !== 'teacher') return;
          const req = snap.val();
          if (!req) return;
          this.renderMicRequestCard(snap.key, req);
          this.incrementQuestionCount();
          this.showToast(`Mic request: ${req.senderName}`, "info");
        });

        const hRef = ref(this.db, `chats/${this.state.room}/handRaises`);
        onChildAdded(hRef, async (snap) => {
          if (this.state.role !== 'teacher') return;
          const req = snap.val();
          if (!req) return;
          this.renderHandRaiseCard(snap.key, req);
          this.incrementQuestionCount();
          this.showToast(`Hand raise: ${req.senderName}`, "info");
        });

        const sRef = ref(this.db, `chats/${this.state.room}/studentResponses`);
        onChildAdded(sRef, async (snap) => {
          if (this.state.role !== 'teacher') return;
          const resp = snap.val();
          if (!resp) return;

          const teacherText = resp.textForTeacher ? resp.textForTeacher : await this.translateText(resp.text, resp.lang, this.state.lang);
          this.renderStudentSpeechCard({
            sender: resp.senderName,
            text: teacherText,
            original: resp.text,
            audioBase64: resp.audioBase64 || null,
            audioMimeType: resp.audioMimeType || 'audio/webm'
          });

          this.incrementQuestionCount();
          if (this.state.isTTSActive) this.queueAudio(teacherText, 'Female');
        });

        const cRef = ref(this.db, `chats/${this.state.room}/studentChats`);
        onChildAdded(cRef, async (snap) => {
          if (this.state.role !== 'teacher') return;
          const resp = snap.val();
          if (!resp) return;

          const teacherText = resp.textForTeacher ? resp.textForTeacher : await this.translateText(resp.text, resp.lang, this.state.lang);
          this.renderStudentChatCard({ sender: resp.senderName, text: teacherText, original: resp.text });

          this.incrementQuestionCount();
          if (this.state.isTTSActive) this.queueAudio(teacherText, 'Female');
        });

        const studentsRef = ref(this.db, `chats/${this.state.room}/students`);
        onChildAdded(studentsRef, (snap) => {
          if (this.state.role !== 'teacher') return;
          const student = snap.val();
          if (!student) return;
          this.renderStudentListItem(student);
          this.updateStudentCount();
        });

        const reactionsRef = ref(this.db, `chats/${this.state.room}/reactions`);
        onChildAdded(reactionsRef, (snap) => {
          if (this.state.role !== 'teacher') return;
          const reaction = snap.val();
          if (!reaction) return;
          this.addNotification(reaction.emoji, reaction.senderName, reaction.timestamp);
        });
      }

      // ===== Teacher VAD + STT segmentation broadcast =====
      async toggleMic() {
        if (this.state.isMicActive) {
          await this.stopWebSpeech();
          this.state.isMicActive = false;
          this.updateMicUI(false);
        } else {
          try {
            await this.startWebSpeech();
            this.state.isMicActive = true;
            this.updateMicUI(true);
            this.showToast("Broadcasting Live (VAD + Segmentation)", "success");
          } catch (e) {
            this.showToast("Microphone Error: " + e.message, "error");
            this.state.isMicActive = false;
            this.updateMicUI(false);
          }
        }
      }

      async startWebSpeech() {
        if (!SpeechRecognition) throw new Error("Web Speech API not supported");

        if ('wakeLock' in navigator) {
          try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (_) { }
        }

        // Separate mic stream for VAD (WebSpeech does not give you raw audio)
        this.teacherStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        this.teacherBuffer = '';
        this.teacherInterim = '';

        const bars = document.querySelectorAll('#mic-status div');

        this.teacherVAD = new SimpleVAD(this.teacherStream, {
          minSilenceMs: 850,
          userThreshold: 0.018,
          onLevel: (lvl) => {
            bars.forEach((b, i) => {
              const h = 3 + Math.min(12, Math.floor(lvl * 10)) + i;
              b.style.height = `${h}px`;
            });
          },
          onSpeechStart: () => { bars.forEach(b => b.classList.add('bg-red-400')); },
          onSpeechEnd: () => {
            // If user stops speaking without punctuation, flush remainder as one message
            if (this.teacherBuffer && this.teacherBuffer.trim().length > 0) {
              const leftovers = this.flushAsSentence(this.teacherBuffer);
              leftovers.forEach(s => this.broadcastMessage(s));
              this.teacherBuffer = '';
              this.teacherInterim = '';
              this.updateTeacherTranscriptUI();
            }
          }
        });
        await this.teacherVAD.start();

        this.recognition = new SpeechRecognition();
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        this.recognition.lang = this.state.lang || 'en-US';
        this.recognition.maxAlternatives = 1;

        this.recognition.onresult = (event) => {
          let interimTranscript = '';
          let finalTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) finalTranscript += transcript;
            else interimTranscript += transcript;
          }

          this.teacherInterim = interimTranscript || '';

          if (finalTranscript) {
            const cleaned = this.cleanOkeyPeriods(finalTranscript.trim());
            this.teacherBuffer = (this.teacherBuffer ? (this.teacherBuffer + ' ') : '') + cleaned;

            const seg = this.extractSentences(this.teacherBuffer);
            seg.sentences.forEach(s => this.broadcastMessage(s));
            this.teacherBuffer = seg.remainder || '';
          }

          this.updateTeacherTranscriptUI();
        };

        this.recognition.onerror = (event) => {
          console.error('Teacher STT error:', event.error);
          this.showToast(`Speech error: ${event.error}`, 'error');
        };

        this.recognition.onend = () => {
          if (this.state.isMicActive) {
            setTimeout(() => {
              try { this.recognition.start(); } catch (_) { }
            }, 120);
          }
        };

        this.recognition.start();
      }

      updateTeacherTranscriptUI() {
        const ui = document.getElementById('teacher-transcript');
        if (!ui) return;
        const text = `${(this.teacherBuffer || '').trim()} ${(this.teacherInterim || '').trim()}`.trim();
        ui.innerText = text || 'Listening...';
      }

      async stopWebSpeech() {
        try { if (this.recognition) this.recognition.stop(); } catch (_) { }
        this.recognition = null;

        try { if (this.wakeLock) await this.wakeLock.release(); } catch (_) { }
        this.wakeLock = null;

        try { if (this.teacherVAD) await this.teacherVAD.stop(); } catch (_) { }
        this.teacherVAD = null;

        try {
          if (this.teacherStream) this.teacherStream.getTracks().forEach(t => t.stop());
        } catch (_) { }
        this.teacherStream = null;

        this.teacherBuffer = '';
        this.teacherInterim = '';
      }

      updateMicUI(active) {
        const btn = document.getElementById('mic-btn');
        const bars = document.querySelectorAll('#mic-status div');
        if (!btn) return;

        if (active) {
          btn.classList.add('bg-red-500', 'text-white', 'mic-active-ring');
          btn.classList.remove('bg-gray-100', 'text-gray-600');
          btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
          bars.forEach(b => b.classList.add('bg-red-400'));
        } else {
          btn.classList.remove('bg-red-500', 'text-white', 'mic-active-ring');
          btn.classList.add('bg-gray-100', 'text-gray-600');
          btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-sm"></i>';
          bars.forEach(b => b.classList.remove('bg-red-400'));
        }
      }

      broadcastMessage(text) {
        const t = (text || '').replace(/\s+/g, ' ').trim();
        if (!t) return;

        push(ref(this.db, `chats/${this.state.room}/messages`), {
          text: t,
          lang: this.state.lang,
          senderName: this.state.name,
          senderId: this.state.name,
          gender: this.state.gender,
          timestamp: Date.now()
        });
      }

      // ===== Teacher UI rendering (unchanged logic) =====
      switchTeacherTab(tab) {
        const questionsBtn = document.getElementById('tab-questions-btn');
        const studentsBtn = document.getElementById('tab-students-btn');
        const questionsContent = document.getElementById('tab-questions-content');
        const studentsContent = document.getElementById('tab-students-content');

        if (tab === 'questions') {
          questionsBtn.classList.add('bg-blue-100', 'text-blue-700');
          questionsBtn.classList.remove('text-gray-500', 'hover:bg-gray-100');
          studentsBtn.classList.remove('bg-blue-100', 'text-blue-700');
          studentsBtn.classList.add('text-gray-500', 'hover:bg-gray-100');
          questionsContent.classList.remove('hidden');
          studentsContent.classList.add('hidden');
        } else {
          studentsBtn.classList.add('bg-blue-100', 'text-blue-700');
          studentsBtn.classList.remove('text-gray-500', 'hover:bg-gray-100');
          questionsBtn.classList.remove('bg-blue-100', 'text-blue-700');
          questionsBtn.classList.add('text-gray-500', 'hover:bg-gray-100');
          studentsContent.classList.remove('hidden');
          questionsContent.classList.add('hidden');
        }
      }

      addNotification(emoji, senderName, timestamp) {
        const list = document.getElementById('notifications-list');
        const empty = document.getElementById('notifications-empty');
        if (empty) empty.remove();

        const item = document.createElement('div');
        item.className = "bg-gray-50 border border-gray-100 p-3 rounded-xl flex items-center gap-3 animate-slide-up";
        item.innerHTML = `
          <span class="text-2xl">${emoji}</span>
          <div class="flex-1">
            <p class="text-sm font-semibold text-gray-800">${senderName}</p>
            <p class="text-[10px] text-gray-400">Sent a reaction</p>
          </div>
        `;
        list.prepend(item);

        this.updateNotifBadge();
        this.showToast(`${emoji} from ${senderName}`, "info");
      }

      updateNotifBadge() {
        const list = document.getElementById('notifications-list');
        const badge = document.getElementById('notif-badge');
        const count = list.querySelectorAll('.animate-slide-up').length;
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : String(count);
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }

      clearNotifications() {
        const list = document.getElementById('notifications-list');
        list.innerHTML = `
          <div id="notifications-empty" class="text-center py-10 opacity-40">
            <i class="fa-regular fa-bell-slash text-2xl mb-2 text-gray-400"></i>
            <p class="text-xs text-gray-500">No notifications yet</p>
          </div>
        `;
        document.getElementById('notif-badge')?.classList.add('hidden');
        this.toggleModal('notifications');
      }

      updateStudentCount() {
        const list = document.getElementById('students-list');
        const count = document.getElementById('student-count');
        count.innerText = String(list.children.length);
      }

      renderStudentListItem(student) {
        const list = document.getElementById('students-list');
        document.getElementById('students-empty')?.remove();
        if (document.getElementById(`student-item-${student.name}`)) return;

        const langInfo = LANGUAGES.find(l => l.code === student.lang);
        const flag = langInfo?.flag || '';
        const card = document.createElement('div');
        card.id = `student-item-${student.name}`;
        card.className = "bg-white border border-gray-100 p-3 rounded-xl shadow-sm flex items-center justify-between gap-3";
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
              ${student.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-800">${student.name}</p>
              <p class="text-[11px] text-gray-500">${flag} ${student.langName || student.lang}</p>
            </div>
          </div>
          <span class="text-[9px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full uppercase">Online</span>
        `;
        list.appendChild(card);
      }

      ensureTeacherListHasNoPlaceholder() { document.getElementById('teacher-empty')?.remove(); }

      incrementQuestionCount() {
        const count = document.getElementById('question-count');
        count.innerText = String((parseInt(count.innerText || '0', 10) || 0) + 1);
      }

      renderQuestionCard({ kind, sender, text, original }) {
        const list = document.getElementById('teacher-questions');
        this.ensureTeacherListHasNoPlaceholder();
        const card = document.createElement('div');
        card.className = "bg-white border border-blue-100 p-3 rounded-xl shadow-sm animate-slide-up cursor-pointer hover:border-blue-300 transition-colors";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-1">
            <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${sender}</span>
            <span class="text-[10px] font-black text-blue-500 uppercase tracking-tight">${kind}</span>
          </div>
          <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
          <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
        `;
        list.prepend(card);
      }

      renderMicRequestCard(reqKey, req) {
        const list = document.getElementById('teacher-questions');
        this.ensureTeacherListHasNoPlaceholder();

        const card = document.createElement('div');
        card.className = "bg-white border border-emerald-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-emerald-300 transition-colors";
        card.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded uppercase">${req.senderName}</span>
                <span class="text-[10px] font-black text-emerald-600 uppercase tracking-tight">requests to speak</span>
              </div>
              <p class="text-[11px] text-gray-500 mt-1 truncate">Language: ${(req.lang || '').toUpperCase()}</p>
            </div>
            <button class="approve-btn btn-modern px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold flex items-center gap-2">
              <i class="fa-solid fa-check"></i>
              Approve
            </button>
          </div>
        `;

        card.querySelector('.approve-btn').addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          await this.approveMicRequest(reqKey, req);
          card.remove();
        });

        list.prepend(card);
      }

      renderHandRaiseCard(reqKey, req) {
        const list = document.getElementById('teacher-questions');
        this.ensureTeacherListHasNoPlaceholder();

        const card = document.createElement('div');
        card.className = "bg-white border border-amber-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-amber-300 transition-colors";
        card.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded uppercase">${req.senderName}</span>
                <span class="text-[10px] font-black text-amber-600 uppercase tracking-tight">raised hand</span>
              </div>
              <p class="text-[11px] text-gray-500 mt-1 truncate">Language: ${(req.lang || '').toUpperCase()}</p>
            </div>
            <button class="approve-chat btn-modern px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold flex items-center gap-2">
              <i class="fa-solid fa-check"></i>
              Approve
            </button>
          </div>
        `;

        card.querySelector('.approve-chat').addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          await this.approveChatRequest(reqKey, req);
          card.remove();
        });

        list.prepend(card);
      }

      async approveMicRequest(reqKey, req) {
        try {
          await push(ref(this.db, `chats/${this.state.room}/approvedSpeakers`), {
            speakerName: req.senderName,
            approvedAt: Date.now(),
            teacherLang: this.state.lang
          });
          await remove(ref(this.db, `chats/${this.state.room}/requests/${reqKey}`));
          this.showToast(`Approved: ${req.senderName}`, "success");
        } catch (e) {
          this.showToast("Approve failed: " + e.message, "error");
        }
      }

      async approveChatRequest(reqKey, req) {
        try {
          await push(ref(this.db, `chats/${this.state.room}/approvedChat`), {
            speakerName: req.senderName,
            approvedAt: Date.now(),
            teacherLang: this.state.lang
          });
          await remove(ref(this.db, `chats/${this.state.room}/handRaises/${reqKey}`));
          this.showToast(`Chat approved: ${req.senderName}`, "success");
        } catch (e) {
          this.showToast("Approve failed: " + e.message, "error");
        }
      }

      renderStudentSpeechCard({ sender, text, original, audioBase64, audioMimeType }) {
        const list = document.getElementById('teacher-questions');
        this.ensureTeacherListHasNoPlaceholder();

        const card = document.createElement('div');
        card.className = "bg-white border border-purple-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-purple-300 transition-colors";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-1 gap-2">
            <span class="text-[10px] font-bold bg-purple-50 text-purple-700 px-1.5 py-0.5 rounded uppercase">${sender}</span>
            <span class="text-[10px] font-black text-purple-600 uppercase tracking-tight">student speech</span>
          </div>
          <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
          <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
          ${audioBase64 ? `
            <div class="mt-2">
              <button class="play-audio btn-modern px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold flex items-center gap-2">
                <i class="fa-solid fa-play"></i> Play Audio
              </button>
            </div>
          ` : `<div class="mt-2 text-[10px] text-gray-400 font-semibold">(Audio not included)</div>`}
        `;

        if (audioBase64) {
          card.querySelector('.play-audio').addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            this.playAudioFromBase64(audioBase64, audioMimeType || 'audio/webm');
          });
        }

        list.prepend(card);
      }

      renderStudentChatCard({ sender, text, original }) {
        const list = document.getElementById('teacher-questions');
        this.ensureTeacherListHasNoPlaceholder();

        const card = document.createElement('div');
        card.className = "bg-white border border-sky-100 p-3 rounded-xl shadow-sm animate-slide-up hover:border-sky-300 transition-colors";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-1">
            <span class="text-[10px] font-bold bg-sky-50 text-sky-600 px-1.5 py-0.5 rounded uppercase">${sender}</span>
            <span class="text-[10px] font-black text-sky-600 uppercase tracking-tight">chat</span>
          </div>
          <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
          <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
        `;
        list.prepend(card);
      }

      playAudioFromBase64(base64, mimeType) {
        try {
          const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
          const blob = new Blob([bytes], { type: mimeType || 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.onended = () => URL.revokeObjectURL(url);
          audio.play();
        } catch (e) {
          this.showToast("Audio play failed", "error");
        }
      }

      sendQuestion() {
        const val = document.getElementById('q-input')?.value?.trim();
        if (!val) return;

        push(ref(this.db, `chats/${this.state.room}/questions`), {
          text: val,
          lang: this.state.lang,
          senderName: this.state.name,
          timestamp: Date.now()
        });

        document.getElementById('q-input').value = '';
        this.toggleModal('question');
        this.showToast("Question Sent", "success");
      }

      sendReaction(emoji) {
        this.showToast(`Sent ${emoji}`, "success");

        const float = document.createElement('div');
        float.innerText = emoji;
        float.className = 'fixed bottom-20 left-1/2 text-4xl pointer-events-none animate-bounce z-50';
        float.style.transition = 'all 1s ease-out';
        document.body.appendChild(float);
        setTimeout(() => {
          float.style.transform = 'translateY(-200px) scale(0)';
          float.style.opacity = '0';
          setTimeout(() => float.remove(), 1000);
        }, 50);

        if (this.state.role === 'student' && this.state.room) {
          push(ref(this.db, `chats/${this.state.room}/reactions`), {
            emoji,
            senderName: this.state.name,
            timestamp: Date.now()
          }).catch(() => { });
        }
      }

      copyCode() {
        navigator.clipboard.writeText(this.state.room);
        this.showToast("Copied to clipboard", "success");
      }

      async translateText(text, source, target) {
        if (!text) return '';
        if (!source || !target) return text;
        if (source === target) return text;

        let normalizedText = text;
        if (source === 'nl' || source === 'nl-BE') {
          normalizedText = text.replace(/\b(ok√©|okee|okey|oke)\b/gi, 'okay');
        }

        try {
          const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURI(normalizedText)}`);
          const json = await res.json();
          return json[0][0][0];
        } catch (e) {
          return text;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => new SuccesApp());
  </script>
</body>

</html>
